name: Deploy + Webhooks + Runware

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Prompt to send to Runware and webhooks'
        required: true
        default: 'Hello'

jobs:
  deploy-and-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------
      # 1️⃣ Деплой фронта
      # -----------------------------
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .

      # -----------------------------
      # 2️⃣ Вызов вебхуков
      # -----------------------------
      - name: Call main webhook
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{"message":"Frontend triggered main webhook with prompt: ${{ github.event.inputs.prompt }}"}'

      - name: Call chat webhook
        env:
          CHAT_WEBHOOK_URL: ${{ secrets.CHAT_WEBHOOK_URL }}
        run: |
          curl -X POST "$CHAT_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{"message":"Frontend triggered chat webhook with prompt: ${{ github.event.inputs.prompt }}"}'

      - name: Call Telegram bot
        env:
          TELEGRAM_BOT_URL: ${{ secrets.TELEGRAM_BOT_URL }}
        run: |
          curl -X POST "$TELEGRAM_BOT_URL" \
            -H "Content-Type: application/json" \
            -d '{"text":"Frontend triggered Telegram webhook with prompt: ${{ github.event.inputs.prompt }}"}'

      # -----------------------------
      # 3️⃣ Вызов Runware API
      # -----------------------------
      - name: Call Runware API
        env:
          RUNWARE_API_KEY: ${{ secrets.RUNWARE_API_KEY }}
        run: |
          curl -X POST "https://api.runware.com/endpoint" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $RUNWARE_API_KEY" \
            -d '{"prompt":"${{ github.event.inputs.prompt }}"}'

      # -----------------------------
      # 4️⃣ Health check фронта
      # -----------------------------
      - name: Health check
        run: |
          sleep 10
          curl -f https://KawaaBongaaa.github.io/pixplace/ || echo "⚠️ Health check failed (may still be ok)"
