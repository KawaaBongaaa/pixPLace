name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Replace placeholders with SECRETS
      run: |
        echo "üîß Replacing placeholders with GitHub Secrets..."

        # RUNWARE_API_KEY
        if [ -n "${{ secrets.RUNWARE_API_KEY }}" ]; then
          sed -i "s/PLACEHOLDER_RUNWARE_API_KEY/${{ secrets.RUNWARE_API_KEY }}/g" app_modern.js
          echo "‚úÖ RUNWARE_API_KEY replaced"
        else
          echo "‚ö†Ô∏è RUNWARE_API_KEY secret NOT FOUND"
        fi

        # WEBHOOK_URL
        if [ -n "${{ secrets.WEBHOOK_URL }}" ]; then
          sed -i "s|PLACEHOLDER_WEBHOOK_URL|${{ secrets.WEBHOOK_URL }}|g" app_modern.js
          echo "‚úÖ WEBHOOK_URL replaced"
        else
          echo "‚ö†Ô∏è WEBHOOK_URL secret NOT FOUND"
        fi

        # CHAT_WEBHOOK_URL
        if [ -n "${{ secrets.CHAT_WEBHOOK_URL }}" ]; then
          sed -i "s|PLACEHOLDER_CHAT_WEBHOOK_URL|${{ secrets.CHAT_WEBHOOK_URL }}|g" app_modern.js
          echo "‚úÖ CHAT_WEBHOOK_URL replaced"
        else
          echo "‚ö†Ô∏è CHAT_WEBHOOK_URL secret NOT FOUND"
        fi

        # TELEGRAM_BOT_URL
        if [ -n "${{ secrets.TELEGRAM_BOT_URL }}" ]; then
          sed -i "s|PLACEHOLDER_TELEGRAM_BOT_URL|${{ secrets.TELEGRAM_BOT_URL }}|g" app_modern.js
          echo "‚úÖ TELEGRAM_BOT_URL replaced"
        else
          echo "‚ö†Ô∏è TELEGRAM_BOT_URL secret NOT FOUND"
        fi

        echo "üéØ Replacement process completed"

    - name: Verify replacements
      run: |
        echo "üîç Searching for leftover placeholders..."
        if grep -q "PLACEHOLDER_" app_modern.js; then
          echo "‚ùå Some placeholders were NOT replaced!"
          exit 1
        else
          echo "‚úÖ All placeholders replaced"
        fi

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: success()
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        # cname: your-domain.com

  health-check:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: success()

    steps:
    - name: Health check
      run: |
        echo "üè• Checking deployment..."
        sleep 10
        curl -f https://KawaaBongaaa.github.io/pixplace/ || echo "‚ö†Ô∏è Health check failed (may still be ok)"
