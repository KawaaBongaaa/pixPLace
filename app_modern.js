import { en } from './dictionaries/en.js';
import { ru } from './dictionaries/ru.js';
import { es } from './dictionaries/es.js';
import { fr } from './dictionaries/fr.js';
import { de } from './dictionaries/de.js';
import { zh } from './dictionaries/zh.js';
import { pt } from './dictionaries/pt.js';
import { ar } from './dictionaries/ar.js';
import { hi } from './dictionaries/hi.js';
import { ja } from './dictionaries/ja.js';
import { it } from './dictionaries/it.js';
import { ko } from './dictionaries/ko.js';
import { vi } from './dictionaries/vi.js';
import { th } from './dictionaries/th.js';
import { tr } from './dictionaries/tr.js';
import { pl } from './dictionaries/pl.js';

// ‚úÖ –ù–û–í–´–ï: –ò–º–ø–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–æ–≤ –≤–º–µ—Å—Ç–æ –ø—Ä—è–º—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
import { initializeGlobalServices } from './core/services.js';
import { AppStateManager } from './store/app-state.js';
import { showScreen, showApp, showResult, displayFullResult, showResultToast, showProcessing, showAuth } from './screen-manager.js';

// –ò–º–ø–æ—Ä—Ç ScreenManager –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
import { ScreenManager } from './screen-manager.js';
import { updateUserNameDisplay, updateUserBalanceDisplay, showSubscriptionNotice, showWarningAboutNoImage, toggleModeDetails, showHistory } from './navigation-manager.js';
import { startSnowfall, readFileAsDataURL, maybeCompressImage, sanitizeJsonString, generateUUIDv4, isIOS, downloadOrShareImage, triggerHapticFeedback } from './utils.js';
import { createCoachButton, initAICoach, createChatButton } from './ai-coach.js';
import { updateHistoryItemWithImage, createLoadingHistoryItem, viewHistoryItem } from './history-manager.js';


// üöÄ Modern AI Image Generator WebApp

/**
 * BYPASS AUTH FLAG
 *
 * üöß TEMPORARY WORKAROUND FOR TESTING üöß
 *
 * Set to true to skip authentication for development/testing.
 * Set back to false before production deployment.
 */
const BYPASS_AUTH = false; // CHANGE TO FALSE BEFORE DEPLOYMENT!

// Configuration
const CONFIG = {
    WEBHOOK_URL: 'https://hook.us2.make.com/x2hgl6ocask8hearbpwo3ch7pdwpdlrk', // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® WEBHOOK!
    CHAT_WEBHOOK_URL: 'https://hook.us2.make.com/xsj1a14x1qaterd8fcxrs8e91xwhvjh6', // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê WEBHOOK –î–õ–Ø –ß–ê–¢–ê!
    TIMEOUT: 120000, // 120 —Å–µ–∫—É–Ω–¥
    LANGUAGES: ['en', 'ru', 'es', 'fr', 'de', 'zh', 'pt', 'ar', 'hi', 'ja', 'it', 'ko', 'tr', 'pl', 'vi', 'th'],
    DEFAULT_LANGUAGE: 'en',
    DEFAULT_THEME: 'dark', // 'light', 'dark', 'auto'
    IMGBB_API_KEY: '34627904ae4633713e1fee94a243794e', // —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤/–ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ (deprecated - –∏—Å–ø–æ–ª—å–∑—É–µ–º Runware)
    RUNWARE_API_KEY: 'jOXX5kq8n10wWpcRFnnScQ0hsNJKWsg2', // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® RUNWARE API KEY!
    MAX_IMAGE_MB: 10,
    ALLOWED_TYPES: ['image/jpeg', 'image/png', 'image/webp', 'image/gif'],
    PREVIEW_MAX_W: 1024,
    PREVIEW_MAX_H: 1024,
    PREVIEW_JPEG_QUALITY: 0.9,
    TELEGRAM_BOT_URL: 'https://t.me/pixPLaceBot?start=user_shared', // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
    SHARE_DEFAULT_HASHTAGS: '#pixPLaceBot #Telegram #Ai',
    MAINTENANCE_MODE: false // –†–µ–∂–∏–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
};

// üöÄ –≠–∫—Å–ø–æ—Ä—Ç CONFIG –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π (ai-coach.js)
window.CONFIG = CONFIG;

// üî• –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï MAINTENANCE_MODE –í LOCALSTORAGE –î–õ–Ø –î–û–°–¢–£–ü–ê –ò–ó –î–†–£–ì–ò–• –°–¢–†–ê–ù–ò–¶
try {
    localStorage.setItem('pixplace_maintenance_mode', CONFIG.MAINTENANCE_MODE ? 'true' : 'false');
    console.log('üíæ Maintenance mode saved to localStorage:', CONFIG.MAINTENANCE_MODE);
} catch (error) {
    console.warn('‚ùå Could not save maintenance mode to localStorage:', error);
}



// üåç Translations
const TRANSLATIONS = {
    en,
    ru,
    es,
    fr,
    de,
    zh,
    pt,
    ar,
    hi,
    ja,
    it,
    ko,
    tr,
    pl,
    vi,
    th
};

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º TRANSLATIONS –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ AppStateManager
window.TRANSLATIONS = TRANSLATIONS;

// üéØ Global state - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º AppStateManager –∏–∑ –º–æ–¥—É–ª—è store/app-state.js
const appState = new AppStateManager();

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º appState –≤ window –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
window.appState = appState;

// üî• –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
appState.loadSettings();



// ‚ö° Ultra-Fast Global Image Loading Manager - Max Performance
class GlobalHistoryLoader {
    constructor() {
        // Singleton pattern - only one Observer per app
        if (GlobalHistoryLoader.instance) {
            return GlobalHistoryLoader.instance;
        }

        this.imageObserver = new IntersectionObserver(
            this.handleIntersection.bind(this),
            {
                rootMargin: '150px', // –µ—â–µ —à–∏—Ä–µ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞—Ö–≤–∞—Ç–∞ –≤–∏–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                threshold: [0.01, 0.005, 0.001], // —É–ª—å—Ç—Ä–∞-–∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ –¥–ª—è –ª—é–±–æ–≥–æ –Ω–∞–º–µ–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏
                root: null, // viewport
            }
        );

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ registry —Å Map –¥–ª—è O(1) –¥–æ—Å—Ç—É–ø–∞
        this.observedImages = new Map();
        this.loadingQueue = new Set();
        this.maxConcurrent = 12; // –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏ (—É–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏)
        this.pendingQueue = []; // –æ—á–µ—Ä–µ–¥—å –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–∫–∏
        this.logout = false;

        // –ù–æ–≤–æ–µ: –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è eager loading –º–∞–ª–µ–Ω—å–∫–∏—Ö —Å–ø–∏—Å–∫–æ–≤
        this.eagerLoadingLimit = 50; // –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ –¥–æ 50 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π - eager loading

        GlobalHistoryLoader.instance = this;
        console.log('üöÄ Ultra-Fast Global History Loader initialized with aggressive loading');
    }

    handleIntersection(entries, observer) {
        if (this.logout) return;

        // –£–±–∏—Ä–∞–µ–º —Å–ø–∞–º - –ª–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–Ω–æ–≥–æ –∑–∞–ø–∏—Å–µ–π (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ)
        if (entries.length > 10) {
            console.warn('‚ö° IntersectionObserver triggered:', entries.length, 'entries - performance warning');
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º–∏ –ø–æ—Ä–æ–≥–∞–º–∏ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        const highPriorityEntries = [];
        const normalPriorityEntries = [];
        const lowPriorityEntries = [];
        const invisibleEntries = [];

        for (const entry of entries) {
            // –£–±–∏—Ä–∞–µ–º —Å–ø–∞–º - –ª–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤ 2% —Å–ª—É—á–∞–µ–≤ –∏ —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            if (Math.random() < 0.02) {
                console.log('üìä Entry intersection:', entry.intersectionRatio.toFixed(3));
            }

            if (entry.isIntersecting) {
                // –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–∂–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –≤–∏–¥–∏–º–æ—Å—Ç—å—é (1%+ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
                if (entry.intersectionRatio >= 0.01) {
                    highPriorityEntries.push(entry);
                }
                // –ù–æ—Ä–º–∞–ª—å–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç - –æ—á–µ–Ω—å —Å–ª–∞–±–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å (0.5%+)
                else if (entry.intersectionRatio >= 0.005) {
                    normalPriorityEntries.push(entry);
                }
                // –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å (0.1%+)
                else if (entry.intersectionRatio > 0.001) {
                    lowPriorityEntries.push(entry);
                }
            } else {
                invisibleEntries.push(entry);
            }
        }

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –≤–Ω–∞—á–∞–ª–µ
        if (highPriorityEntries.length > 0 || normalPriorityEntries.length > 0) {
            console.log('üéØ Processing high/normal priority images:', highPriorityEntries.length + normalPriorityEntries.length);
            this.processVisibleImages([...highPriorityEntries, ...normalPriorityEntries]);
        }

        // –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        if (lowPriorityEntries.length > 0) {
            setTimeout(() => {
                console.log('üéØ Processing low priority images:', lowPriorityEntries.length);
                this.processVisibleImages(lowPriorityEntries);
            }, 200);
        }

        // –û—á–∏—â–∞–µ–º –Ω–µ–≤–∏–¥–∏–º—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
        if (invisibleEntries.length > 0) {
            setTimeout(() => {
                this.cleanupInvisibleImages(invisibleEntries);
            }, 1000); // –æ—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
        }
    }

    processVisibleImages(entries) {
        console.log(`üëÅÔ∏è Processing ${entries.length} visible images`);

        for (const entry of entries) {
            const img = entry.target;

            // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Map
            if (!this.observedImages.has(img)) continue;

            // –£–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            if (img.src && !img.dataset.src) {
                this.safeUnobserve(img);
                continue;
            }

            // –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å src –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
            if (img.dataset.src && !this.loadingQueue.has(img)) {
                this.startLoading(img);
            }
        }
    }

    startLoading(img) {
        const container = img.closest('.history-mini');

        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
        if (!container || container.classList.contains('history-loading')) {
            return;
        }

        // –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫ - –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
        if (this.loadingQueue.size >= this.maxConcurrent) {
            this.pendingQueue.push(img);
            return;
        }

        this.loadingQueue.add(img);

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ src —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        const loadPromise = new Promise((resolve, reject) => {
            img.onload = () => {
                img.classList.add('loaded');
                delete img.dataset.src; // –æ—á–∏—â–∞–µ–º data-src
                console.log('‚úÖ Image loaded successfully');
                resolve();
            };

            img.onerror = () => {
                console.warn('‚ùå Image load failed - showing placeholder');
                const placeholder = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMvb3JnLzIwMDAvc3ZnIj4KPGRlZnM+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+LmV4cGlyZWQtdGV4dHtiYTpnZW5lcmFsIFNhbnMsQXJpYWwsSGVsdmV0aWNhLHNhbnMtc2VyaWY7Zm9udC1zaXplOiAxNHB4O2ZpbGw6ICM5OTk5OTk7fTwvc3R5bGU+CjwvZGVmcz4KPHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2Y0ZjRmNCIvPgo8dGV4dCB4PSI1MCUiIHk9IjUwJSIgZHk9Ii4zNWVtIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBjbGFzcz0iZXhwaXJlZC10ZXh0IiBzdHlsZT0iYXVjLWFncmlkLXJvd3M6IHNwYW4gMS8yOyB2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlOyBvcGFjaXR5OiAwLjg7Ij5FeHBpcmVkPC90ZXh0PiAKPC9zdmc+';
                img.src = placeholder;
                resolve();
            };

            // –ó–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏
            img.src = img.dataset.src;
        });

        loadPromise.finally(() => {
            this.loadingQueue.delete(img);
            this.safeUnobserve(img);

            // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –∏–∑ –æ—á–µ—Ä–µ–¥–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –º–µ—Å—Ç–æ
            if (this.pendingQueue.length > 0 && this.loadingQueue.size < this.maxConcurrent) {
                const nextImg = this.pendingQueue.shift();
                this.startLoading(nextImg);
            }
        });
    }

    cleanupInvisibleImages(entries) {
        for (const entry of entries) {
            const img = entry.target;

            // –û—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞–±–ª—é–¥–∞–µ–º—ã–º–∏ –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
            if (img.dataset.src && !img.src) {
                continue;
            }

            // –û—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞–±–ª—é–¥–∞–µ–º—ã–º–∏ –µ—Å–ª–∏ –æ–Ω–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–≥—Ä—É–∑–∫–∏
            if (this.loadingQueue.has(img)) {
                continue;
            }

            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
            this.safeUnobserve(img);
        }
    }

    // üîß –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ú–µ—Ç–æ–¥ –¥–ª—è eager –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    loadEagerForElement(element) {
        if (!element) return;

        const img = element.querySelector('img[data-src]');
        if (!img || !img.dataset.src) return;

        // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ IntersectionObserver
        this.startLoading(img);

        console.log(`‚ö° Eager loaded image: ${img.dataset.src}`);
    }

    // üÜï –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –≤–∏–¥–∏–º—ã—Ö –ø—Ä–µ–≤—å—é –∏—Å—Ç–æ—Ä–∏–∏
    forceLoadVisibleHistoryPreviews() {
        const historyList = document.getElementById('historyList');
        if (!historyList || historyList.classList.contains('hidden')) {
            console.log('üìã –ò—Å—Ç–æ—Ä–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–∫—Ä—ã—Ç–∞ –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º force load');
            return;
        }

        // –ù–∞–π–¥—ë–º –≤—Å–µ img[data-src] –≤ –≤–∏–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö –∏—Å—Ç–æ—Ä–∏–∏
        const visibleImages = historyList.querySelectorAll('.history-mini img[data-src]');
        if (visibleImages.length === 0) {
            console.log('üìã –ù–µ—Ç –ø—Ä–µ–≤—å—é –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏');
            return;
        }

        console.log(`üéØ Force loading ${visibleImages.length} history previews`);

        // –ó–∞–≥—Ä—É–∑–∏–º –≤—Å–µ –ø–æ–¥—Ä—è–¥, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –ª–∏–º–∏—Ç concurrent
        visibleImages.forEach(img => {
            if (img.dataset.src && !img.src) {
                this.startLoading(img);
            }
        });

        console.log('‚úÖ Force load completed');
    }

    observe(img) {
        if (!img || img.nodeType !== 1) return; // –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

        // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Map
        if (this.observedImages.has(img)) return;

        this.imageObserver.observe(img);
        this.observedImages.set(img, true);

        console.log(`üëÅÔ∏è Started observing image: ${img.src || img.dataset.src}`);
    }

    safeUnobserve(img) {
        if (!img || !this.observedImages.has(img)) return;

        try {
            this.imageObserver.unobserve(img);
            this.observedImages.delete(img);
        } catch (error) {
            console.warn('Failed to unobserve image:', error);
        }
    }

    // üîß –î–û–ë–ê–í–õ–ï–ù–ò–ï: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–∞—Å—Å–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
    massCleanup() {
        const historyList = document.getElementById('historyList');
        if (!historyList) return;

        const currentImages = historyList.querySelectorAll('.history-mini img');
        const validImageSet = new WeakSet(Array.from(currentImages));

        let cleanupCount = 0;
        let maxObserversExceeded = 0;

        // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        const MAX_ACTIVE_OBSERVERS = 40; // —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–æ 40 –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü

        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –Ω–∞–±–ª—é–¥–∞–µ–º—ã–º —ç–ª–µ–º–µ–Ω—Ç–∞–º
        for (const [img] of this.observedImages) {
            // –£–¥–∞–ª—è–µ–º –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –±–æ–ª—å—à–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ –≤ –∏—Å—Ç–æ—Ä–∏–∏
            if (!img || !img.isConnected || !validImageSet.has(img)) {
                this.safeUnobserve(img);
                cleanupCount++;
            } else if (this.observedImages.size > MAX_ACTIVE_OBSERVERS && !img.dataset.src) {
                // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ)
                this.safeUnobserve(img);
                maxObserversExceeded++;
            }
        }

        // –û—á–∏—â–∞–µ–º –æ—á–µ—Ä–µ–¥—å –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        for (const img of this.loadingQueue) {
            if (!img || !img.isConnected) {
                this.loadingQueue.delete(img);
                cleanupCount++;
            }
        }

        if (cleanupCount > 0 || maxObserversExceeded > 0) {
            console.log(`üßπ Enhanced Mass cleanup: ${cleanupCount} elements removed, ${maxObserversExceeded} observers trimmed (max: ${MAX_ACTIVE_OBSERVERS})`);
        }
    }

    // üîß –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è –∏ –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
    destroy() {
        // –û—Ç–∫–ª—é—á–∞–µ–º IntersectionObserver
        if (this.imageObserver) {
            this.imageObserver.disconnect();
            console.log('üéØ IntersectionObserver disconnected');
        }

        // –û—á–∏—â–∞–µ–º –≤—Å–µ –Ω–∞–±–ª—é–¥–∞–µ–º—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        for (const [img] of this.observedImages) {
            this.safeUnobserve(img);
        }

        this.observedImages.clear();
        this.loadingQueue.clear();
        this.pendingQueue = [];
        this.logout = true;

        console.log('üßπ GlobalHistoryLoader fully destroyed');
    }
}

// Global instance
const globalHistoryLoader = new GlobalHistoryLoader();

// ‚ö° Smart History Management with Virtualization
class HistoryManager {
    static PAGE_SIZE = 20; // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    static CACHE_SIZE = 100; // —Ä–∞–∑–º–µ—Ä –∫—ç—à–∞ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤

    // –ö—ç—à DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    static elementCache = new Map();
    static currentPage = 0;
    static maxLoadedPage = 0;
    static isLoadingPage = false;

    static getVisibleItems(limit = 15) {
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ (–∏—Å–∫–ª—é—á–∞–µ–º undefined/null)
        const validItems = appState.generationHistory.filter(item =>
            item.result &&
            typeof item.result === 'string' &&
            item.result.trim() !== '' &&
            item.result !== 'undefined'
        );

        return validItems.slice(0, limit);
    }

    static getValidItemsOnly() {
        return appState.generationHistory.filter(item =>
            item.result &&
            typeof item.result === 'string' &&
            item.result.trim() !== '' &&
            item.result !== 'undefined'
        );
    }

    static getItemsForPage(page) {
        const validItems = this.getValidItemsOnly();
        const start = page * this.PAGE_SIZE;
        const end = start + this.PAGE_SIZE;
        return validItems.slice(start, end);
    }

    static getTotalPages() {
        const validCount = this.getValidItemsOnly().length;
        return Math.ceil(validCount / this.PAGE_SIZE);
    }

    static hasMorePages(page) {
        return page < this.getTotalPages() - 1;
    }

    // üîß –î–û–ë–ê–í–õ–ï–ù–ò–ï: —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –µ—Å—Ç—å –ª–∏ –µ—â–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ—Å–ª–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–∫–∏
    static hasMoreItemsAfter(page, itemsPerPage, validItems) {
        const currentEndIndex = (page + 1) * itemsPerPage; // –∏–Ω–¥–µ–∫—Å –∫–æ–Ω—Ü–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä page=0, itemsPerPage=6 -> –∏–Ω–¥–µ–∫—Å 6)
        return currentEndIndex < validItems.length; // –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–∞–ª—å—à–µ
    }

    static getTotalCount() {
        return appState.generationHistory.length;
    }

    static needsShowMore(limit = 15) {
        const validCount = this.getValidItemsOnly().length;
        return validCount > limit;
    }

    static getValidTotalCount() {
        return this.getValidItemsOnly().length;
    }

    // –ú–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–ø–æ–ª—É—á–µ–Ω–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ DOM —ç–ª–µ–º–µ–Ω—Ç–∞ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç —É—Ç–µ—á–µ–∫
    static createHistoryItemElement(item, forceNoCache = false) {
        // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è cacheKey –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–º–∞—Ö–æ–≤ –∫–µ—à–∞
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ID –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)
        const cacheKey = `hist_${item.id}_${item.result || 'no-result'}`;

        // –£–±–∏—Ä–∞–µ–º —Å–ø–∞–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è - –ª–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤ 1% —Å–ª—É—á–∞–µ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        if (Math.random() < 0.01) {
            console.log(`üîë Generated cacheKey: ${cacheKey} for item ${item.id}`);
        }

        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à (–µ—Å–ª–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ)
        if (!forceNoCache && this.elementCache.has(cacheKey)) {
            // –£–±–∏—Ä–∞–µ–º —Å–ø–∞–º –≤ –∫–æ–Ω—Å–æ–ª—å - –ª–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤ 1% —Å–ª—É—á–∞–µ–≤
            if (Math.random() < 0.01) {
                console.log(`‚úÖ Cache hit for item ${item.id}`);
            }
            return this.elementCache.get(cacheKey).cloneNode(true);
        }

        // –£–±–∏—Ä–∞–µ–º —Å–ø–∞–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è - —Ç–æ–ª—å–∫–æ –≤ 5% —Å–ª—É—á–∞–µ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–º–∞—Ö–æ–≤
        if (Math.random() < 0.05) {
            console.log(`üì¶ Cache miss for item ${item.id}, creating new element`);
        }

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
        const element = this.createHistoryItemElementFromScratch(item);

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫—ç—à –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π (success/error) –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ
        if (!forceNoCache && (item.status === 'success' || item.status === 'error')) {
            // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ 80% –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è (—Ä–∞–Ω—å—à–µ –±—ã–ª–æ > CACHE_SIZE)
            if (this.elementCache.size >= Math.floor(this.CACHE_SIZE * 0.8)) {
                this.autoCleanupCache();
            }

            this.elementCache.set(cacheKey, element.cloneNode(true));

            // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—á–∏—â–∞–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è
            if (this.elementCache.size > this.CACHE_SIZE) {
                this.forceCleanupOldElements(5); // –æ—á–∏—â–∞–µ–º 5 —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            }

            console.log(`üíæ Cached element for ${cacheKey}, cache size: ${this.elementCache.size}/${this.CACHE_SIZE}`);
        }

        return element;
    }

    // üîß –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ LRU –ø—Ä–∏–Ω—Ü–∏–ø—É
    static autoCleanupCache() {
        const currentSize = this.elementCache.size;
        if (currentSize < Math.floor(this.CACHE_SIZE * 0.7)) return; // –Ω–µ –æ—á–∏—â–∞–µ–º –µ—Å–ª–∏ –º–µ–Ω—å—à–µ 70%

        const keysToRemove = Math.floor(currentSize * 0.2); // –æ—á–∏—â–∞–µ–º 20% —Å–∞–º—ã—Ö —Å—Ç–∞—Ä—ã—Ö
        this.forceCleanupOldElements(keysToRemove);

        console.log(`üßπ Auto-cleaned history cache: ${currentSize} ‚Üí ${this.elementCache.size}`);
    }

    // üîß –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫—ç—à–∞
    static forceCleanupOldElements(count = 1) {
        const keys = Array.from(this.elementCache.keys());
        for (let i = 0; i < Math.min(count, keys.length); i++) {
            this.elementCache.delete(keys[i]);
        }
    }

    static createHistoryItemElementFromScratch(item) {
        const element = document.createElement('div');
        element.className = 'history-mini';
        element.id = `history-${item.id}`;
        element.onclick = () => viewHistoryItem(item.id);

        element.innerHTML = `
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzc0MTUxIj48L3JlY3Q+PC9zdmc+"
                 data-src="${item.result || ''}"
                 alt="Generated"
                 class="lazy-loading"
                 loading="lazy"
                 decoding="async"
                 ${item.result ? '' : 'style="opacity: 0.7;"'}
                 />
            <p class="history-caption">${new Date(item.timestamp).toLocaleDateString()} | ${appState.translate('style_' + item.style)} | ${appState.translate('mode_' + item.mode)}</p>
        `;

        return element;
    }

    // –ú–µ—Ç–æ–¥ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞
    static clearCache() {
        this.elementCache.clear();
        this.currentPage = 0;
        this.maxLoadedPage = 0;
        this.isLoadingPage = false;
        console.log('üßπ History cache cleared');
    }
}



// üéØ Utility Functions
function showStatus(type, message) {
    const statusBar = document.getElementById('statusBar');
    const statusText = document.querySelector('.status-text');

    if (statusBar && statusText) {
        statusText.textContent = message;
        statusBar.className = `status-bar ${type} show`;

        setTimeout(() => {
            statusBar.classList.remove('show');
        }, 3000);
    }
}

// showToast —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∏–∑ screen-manager.js

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    // window.showResult —É–±–∏—Ä–∞–µ–º - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ showResultToast –∏ displayFullResult
    window.showResultToast = showResultToast;
    window.sendToWebhook = sendToWebhook;

    // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ ScreenManager

    // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–ø–µ—Ä—å –≤ history-manager.js

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
console.log('üîß Checking imported functions availability:');
console.log('- showWarningAboutNoImage:', typeof showWarningAboutNoImage);
console.log('- showScreen, showApp, showResult, displayFullResult:', typeof showScreen, typeof showApp, typeof showResult, typeof displayFullResult);
console.log('- updateUserNameDisplay, updateUserBalanceDisplay:', typeof updateUserNameDisplay, typeof updateUserBalanceDisplay);
console.log('- startSnowfall, readFileAsDataURL, maybeCompressImage:', typeof startSnowfall, typeof readFileAsDataURL, typeof maybeCompressImage);
console.log('- updateHistoryItemWithImage:', typeof updateHistoryItemWithImage);
console.log('- createLoadingHistoryItem:', typeof createLoadingHistoryItem);
console.log('- viewHistoryItem:', typeof viewHistoryItem);

function triggerHaptic(type) {
    if (appState.tg?.HapticFeedback) {
        switch (type) {
            case 'light':
                appState.tg.HapticFeedback.impactOccurred('light');
                break;
            case 'medium':
                appState.tg.HapticFeedback.impactOccurred('medium');
                break;
            case 'heavy':
                appState.tg.HapticFeedback.impactOccurred('heavy');
                break;
            case 'success':
                appState.tg.HapticFeedback.notificationOccurred('success');
                break;
            case 'error':
                appState.tg.HapticFeedback.notificationOccurred('error');
                break;
        }
    }
}


// üìä Processing Animation
function updateProgressBar(elapsed) {
    const progressBar = document.querySelector('.progress-bar');
    const progressFill = document.querySelector('.progress-fill');

    if (progressBar && progressFill) {
        // –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏ (0-100%)
        const maxTime = 60; // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        const progress = Math.min((elapsed / maxTime) * 100, 100);
        progressFill.style.width = progress + '%';
    }

    // –û–±–Ω–æ–≤–∏—Ç—å –∫—Ä—É–≥–æ–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å, –µ—Å–ª–∏ –µ—Å—Ç—å
    const progressCircle = document.querySelector('.progress-circle');
    if (progressCircle) {
        const circumference = 283; // –æ–∫—Ä—É–∂–Ω–æ—Å—Ç—å –∫—Ä—É–≥–∞
        const progress = Math.min((elapsed / 60) * 100, 100);
        const offset = circumference - (progress / 100) * circumference;
        progressCircle.style.strokeDashoffset = offset;
    }
}
function startTimer() {
    const elapsedTimeElement = document.getElementById('elapsedTime');
    let step = 1;

    appState.timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - appState.startTime) / 1000);
        if (elapsedTimeElement) {
            elapsedTimeElement.textContent = elapsed + 's';
        }
        updateProgressBar(elapsed);
        // Update steps based on time

    }, 1000);
}

function stopTimer() {
    if (appState.timerInterval) {
        clearInterval(appState.timerInterval);
        appState.timerInterval = null;
    }
}

// üìã History Management moved to history-manager.js

// And all history-related functions moved to history-manager.js module

// üñºÔ∏è UI Initialization
// üé¨ Screen Management with cleanup
let carouselCleanup = null;

const showLoadingScreen = () => {
    document.getElementById('loadingScreen').classList.add('active');
};

const hideLoadingScreen = () => {
    document.getElementById('loadingScreen').classList.remove('active');
};

// Cleanup function for memory leaks
function cleanupMemoryLeaks() {
    // Disconnect Global History Loader
    if (globalHistoryLoader) {
        globalHistoryLoader.destroy();
    }

    // Clear any pending timers
    if (appState.timerInterval) {
        clearInterval(appState.timerInterval);
        appState.timerInterval = null;
    }

    // Remove carousel event listeners
    if (carouselCleanup) {
        carouselCleanup();
        carouselCleanup = null;
    }

    console.log('üßπ Memory leaks cleaned up successfully - including global history loader');
}

// Call cleanup on page unload
window.addEventListener('beforeunload', cleanupMemoryLeaks);

/* –§—É–Ω—Ü–∏—è showApp –±—ã–ª–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ screen-manager.js */





// ‚ö° –¢–û–°–¢-–ù–û–¢–ò–§–ò–ö–ê–¶–ò–ò –î–õ–Ø –ù–û–í–´–• –†–ï–ó–£–õ–¨–¢–ê–¢–û–í (–ë–ï–ó –ü–†–ï–†–´–í–ê–ù–ò–Ø –ü–û–õ–ù–û–ì–û –ü–†–û–°–ú–û–¢–†–ê)
let pendingResults = []; // –û–∂–∏–¥–∞—é—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤ —Ç–æ—Å—Ç–∞—Ö

// üî• –≠–ö–°–ü–û–†–¢ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ô –§–£–ù–ö–¶–ò–ò onUserImageChange –î–õ–Ø –î–û–°–¢–£–ü–ê –ò–ó –î–†–£–ì–ò–• –ú–û–î–£–õ–ï–ô
window.onUserImageChange = onUserImageChange;

console.log('‚úÖ onUserImageChange exported to global window scope');

// üî• –≠–ö–°–ü–û–†–¢ createPreviewItem –î–õ–Ø –î–û–°–¢–£–ü–ê –ò–ó user-account.js
window.createPreviewItem = createPreviewItem;

console.log('‚úÖ createPreviewItem exported to global window scope');


function showGeneration() {
    const screens = document.querySelectorAll('.screen');
    screens.forEach(s => {
        s.classList.remove('active');
        s.classList.add('hidden');
    });

    const gen = document.getElementById('generationScreen');
    if (!gen) {
        console.warn('generationScreen –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }

    gen.classList.remove('hidden');
    gen.classList.add('active');

    showBackButton(false);

    // üÜï –î–û–ë–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–≤—å—é –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ history-manager.js
    import('./history-manager.js').then(module => {
        module.updateHistoryDisplay();
    });

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—å—é –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    setTimeout(() => {
        if (globalHistoryLoader) {
            globalHistoryLoader.forceLoadVisibleHistoryPreviews();
        }
    }, 50);
}


// üé® UI Initialization
function initializeUI() {
    // Character counter
    const promptInput = document.getElementById('promptInput');
    const charCounter = document.getElementById('charCounter');

    if (promptInput && charCounter) {
        promptInput.addEventListener('input', function () {
            charCounter.textContent = this.value.length;

            // Auto-resize
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    }

    // Form submission
    const form = document.querySelector('.generation-form');
    if (form) {
        form.addEventListener('submit', generateImage);
    }

    // üîß –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ù–û–í–û–ô –ö–ê–†–£–°–ï–õ–ò –†–ï–ñ–ò–ú–û–í
    initModeCarousel();

    // Update translations
    appState.updateTranslations();

    console.log('‚úÖ UI initialized');
}

// üîß –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –ö–ê–†–£–°–ï–õ–ò –†–ï–ñ–ò–ú–û–í –° EXPANDABLE CARDS
function initModeCarousel() {
    const modeCards = document.querySelectorAll('.mode-card');
    const modeSelect = document.getElementById('modeSelect');
    const modeIndicators = document.querySelectorAll('.mode-indicators .indicator');

    if (!modeCards.length || !modeSelect) {
        console.warn('Mode carousel initialization skipped - elements not found');
        return;
    }

    let currentExpandedCard = null;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ —Å expand/collapse
    const selectMode = (modeValue, cardElement) => {
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–∫—Ä—ã—Ç—ã–π select
        modeSelect.value = modeValue;

        if (currentExpandedCard && currentExpandedCard !== cardElement) {
            // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
            currentExpandedCard.classList.remove('expanded', 'selected');
        }

        if (cardElement) {
            if (currentExpandedCard === cardElement) {
                // –ï—Å–ª–∏ —Ç–∞ –∂–µ –∫–∞—Ä—Ç–æ—á–∫–∞ - —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –µ—ë
                cardElement.classList.remove('expanded', 'selected');
                currentExpandedCard = null;
                console.log('üîΩ Collapsed card');
            } else {
                // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                cardElement.classList.add('expanded', 'selected');
                currentExpandedCard = cardElement;
                console.log('üîº Expanded card:', modeValue);

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
                setTimeout(() => {
                    cardElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center',
                        inline: 'center'
                    });
                }, 300);
            }
        }

        // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —á—Ç–æ –Ω–∏–∫–∞–∫–∏–µ –¥—Ä—É–≥–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ –∏–º–µ—é—Ç expanded
        modeCards.forEach(card => {
            if (card !== cardElement) {
                card.classList.remove('expanded', 'selected');
            }
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
        const modeIndex = Array.from(modeCards).findIndex(card => card.dataset.mode === modeValue);
        modeIndicators.forEach((indicator, index) => {
            indicator.classList.toggle('selected', index === modeIndex);
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        updateImageUploadVisibility();

        console.log(`üéõÔ∏è Selected mode: ${modeValue}, Expanded: ${!!currentExpandedCard}`);
    };

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Ä–µ–∂–∏–º–∞
    modeCards.forEach(card => {
        card.addEventListener('click', () => {
            const mode = card.dataset.mode;
            selectMode(mode, card);
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
    modeIndicators.forEach((indicator, index) => {
        indicator.addEventListener('click', () => {
            const card = modeCards[index];
            if (card) {
                const mode = card.dataset.mode;
                selectMode(mode, card);
            }
        });
    });

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Å–∫—Ä—ã—Ç–æ–≥–æ select (–Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    modeSelect.addEventListener('change', () => {
        const modeValue = modeSelect.value;
        const card = document.querySelector(`.mode-card[data-mode="${modeValue}"]`);
        if (card) {
            selectMode(modeValue, card);
        }
    });

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –ë–ï–ó –î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø updateImageUploadVisibility
    const defaultMode = modeSelect.value || 'photo_session';
    const defaultCard = document.querySelector(`.mode-card[data-mode="${defaultMode}"]`);
    if (defaultCard) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–µ–∑ –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–π –ª–æ–≥–∏–∫–∏
        modeSelect.value = defaultMode;
        currentExpandedCard = defaultCard;
        defaultCard.classList.add('expanded', 'selected');

        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —á—Ç–æ –Ω–∏–∫–∞–∫–∏–µ –¥—Ä—É–≥–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ –∏–º–µ—é—Ç expanded
        modeCards.forEach(card => {
            if (card !== defaultCard) {
                card.classList.remove('expanded', 'selected');
            }
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
        const modeIndex = Array.from(modeCards).findIndex(card => card.dataset.mode === defaultMode);
        modeIndicators.forEach((indicator, index) => {
            indicator.classList.toggle('selected', index === modeIndex);
        });

        console.log(`üéõÔ∏è Initial mode selected: ${defaultMode}, Expanded: ${!!currentExpandedCard}`);
    }

    console.log('üîß Expandable Mode carousel initialized with', modeCards.length, 'modes');
}

// ===== –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: —Å–æ—Å—Ç–æ—è–Ω–∏–µ =====
const userImageState = {
    images: [] // –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ {id, file, dataUrl, uploadedUrl} - –¥–æ 4 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
};

// üî• –≠–ö–°–ü–û–†–¢ –°–û–°–¢–û–Ø–ù–ò–Ø –î–õ–Ø –î–û–°–¢–£–ü–ê –ò–ó –î–†–£–ì–ò–• –ú–û–î–£–õ–ï–ô
window.userImageState = userImageState;
console.log('‚úÖ userImageState exported to window scope');

// ===== –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π =====
function getImageLimitForMode(mode) {
    switch (mode) {
        case 'photo_session':
            return 4; // –¥–æ 4 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è nano banana
        case 'fast_generation':
            return 0; // –≤–æ–æ–±—â–µ –Ω–µ –¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è flux shnel
        default:
            return 1; // –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∂–∏–º—ã - –º–∞–∫—Å–∏–º—É–º 1 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    }
}

function canUploadMoreImages(mode, currentCount) {
    const limit = getImageLimitForMode(mode);
    return currentCount < limit;
}


// ===== –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ UI –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π =====
function updateImageUploadVisibility() {
    const chooseBtn = document.getElementById('chooseUserImage');
    const preview = document.getElementById('userImagePreview');
    const imageCount = userImageState.images.length;
    const hasImages = imageCount > 0;

    const modeSelect = document.getElementById('modeSelect');
    let shouldShowUploadButton, shouldShowPreview;

    if (modeSelect) {
        const currentMode = modeSelect.value;

        // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: —Å–Ω–∏–º–∞–µ–º –º–æ—Ä–≥–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏! –û–Ω–∞ –¥–æ–ª–∂–Ω–∞ —Å–∫—Ä—ã—Ç—å—Å—è —Å—Ä–∞–∑—É –∫–∞–∫ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–≤—å—é
        shouldShowUploadButton = !hasImages && (currentMode !== 'fast_generation');

        if (currentMode === 'fast_generation') {
            // Flux Shnel: –∫–Ω–æ–ø–∫—É –∏ –ø—Ä–µ–≤—å—é –ù–ï –≤–∏–¥–∏–º –≤—Å–µ–≥–¥–∞
            shouldShowPreview = false;

            // –£–î–ê–õ–Ø–ï–ú –í–°–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ —ç—Ç–æ—Ç —Ä–µ–∂–∏–º
            if (hasImages) {
                console.log('üóëÔ∏è –£–¥–∞–ª—è–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ Fast Generation');
                clearAllImages();
                return; // –ø–æ–≤—Ç–æ—Ä–∏–º –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
            }

            console.log(`‚ö° Flux Shnel —Ä–µ–∂–∏–º: –∫–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã—Ç–∞, –ø—Ä–µ–≤—å—é —Å–∫—Ä—ã—Ç–æ (—É–¥–∞–ª–µ–Ω—ã –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)`);
        } else if (currentMode === 'photo_session') {
            // Nano Banana: –ø—Ä–µ–≤—å—é –≤–∏–¥–Ω–æ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
            shouldShowPreview = hasImages;
            console.log(`${!hasImages ? 'üì∏' : '‚ùå'} Photo Session —Ä–µ–∂–∏–º: –∫–Ω–æ–ø–∫–∞ ${shouldShowUploadButton ? '–≤–∏–¥–Ω–∞' : '—Å–∫—Ä—ã—Ç–∞'} (–ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–≤—å—é)`);
        } else {
            // –î—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã: –ø—Ä–µ–≤—å—é –≤–∏–¥–Ω–æ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
            shouldShowPreview = hasImages;

            // –£–î–ê–õ–Ø–ï–ú –õ–ò–®–ù–ò–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –¥–æ –ª–∏–º–∏—Ç–∞ 1 –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ —ç—Ç–∏ —Ä–µ–∂–∏–º—ã
            if (imageCount > 1) {
                console.log(`üóëÔ∏è –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ ${currentMode} (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ 1)`);
                trimImagesToLimit(1);
                return; // –ø–æ–≤—Ç–æ—Ä–∏–º –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
            }

            console.log(`${!hasImages ? 'üé®' : '‚ùå'} –î—Ä—É–≥–æ–π —Ä–µ–∂–∏–º (${currentMode}): –∫–Ω–æ–ø–∫–∞ ${shouldShowUploadButton ? '–≤–∏–¥–Ω–∞' : '—Å–∫—Ä—ã—Ç–∞'} (–ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–≤—å—é)`);
        }
    } else {
        // –ë–µ–∑ —Ä–µ–∂–∏–º–∞ - –∫–Ω–æ–ø–∫–∞ –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –ø—Ä–µ–≤—å—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
        shouldShowUploadButton = !hasImages;
        shouldShowPreview = hasImages;
    }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏
    if (chooseBtn) {
        if (shouldShowUploadButton) {
            chooseBtn.style.setProperty('display', 'inline-flex', 'important');
            chooseBtn.classList.remove('flux-shnel-hidden');
            // üî• –§–ò–ö–°: —É–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –º–æ—Ä–≥–∞–Ω–∏—è —Å—Ä–∞–∑—É –∫–∞–∫ –∫–Ω–æ–ø–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∞
            chooseBtn.style.animation = '';
            console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –í–ò–î–ò–ú–ê (–±–µ–∑ –º–æ—Ä–≥–∞–Ω–∏—è)');
        } else {
            chooseBtn.style.setProperty('display', 'none', 'important');
            chooseBtn.classList.add('flux-shnel-hidden');
            // üî• –§–ò–ö–°: —É–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –º–æ—Ä–≥–∞–Ω–∏—è —Å—Ä–∞–∑—É –∫–∞–∫ –∫–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã—Ç–∞
            chooseBtn.style.animation = '';
            console.log('üö´ –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –°–ö–†–´–¢–ê (—É–¥–∞–ª–∏–ª–∏ –º–æ—Ä–≥–∞–Ω–∏–µ)');
        }
    }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—Ä–µ–≤—å—é
    if (preview) {
        if (shouldShowPreview) {
            preview.classList.remove('flux-shnel-hidden', 'hidden');
            preview.style.setProperty('display', 'block', 'important');
            console.log('‚úÖ –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –í–ò–î–ò–ú–û');
        } else {
            preview.style.setProperty('display', 'none', 'important');
            preview.classList.add('flux-shnel-hidden');
            console.log('üö´ –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –°–ö–†–´–¢–û');
        }
    }

    console.log('üìä –ò–¢–û–ì–û–í–ê–Ø –í–ò–î–ò–ú–û–°–¢–¨:', {
        —Ä–µ–∂–∏–º: modeSelect?.value,
        –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: userImageState.images.length, // –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –ø–æ—Å–ª–µ –≤–æ–∑–º–æ–∂–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
        –∫–Ω–æ–ø–∫–∞_–≤–∏–¥–Ω–∞: shouldShowUploadButton,
        –ø—Ä–µ–≤—å—é_–≤–∏–¥–Ω–æ: shouldShowPreview,
        –¥–µ–π—Å—Ç–≤–∏–µ: '–æ–±–Ω–æ–≤–ª–µ–Ω–æ'
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –º–∞–ª–µ–Ω—å–∫–æ–π –∫–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–≤—å—é
    updateInnerUploadButtonVisibility();
}

// ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –∑–∞–≥—Ä—É–∑–∫–∏ =====
function initUserImageUpload() {
    const input = document.getElementById('userImage');
    const chooseBtn = document.getElementById('chooseUserImage');
    const removeBtn = document.getElementById('removeUserImage');

    chooseBtn?.addEventListener('click', () => input?.click());
    input?.addEventListener('change', onUserImageChange);
    removeBtn?.addEventListener('click', clearUserImage);

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∂–∏–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    const modeSelect = document.getElementById('modeSelect');
    if (modeSelect) {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        updateImageUploadVisibility();

        // –°–ª—É—à–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
        modeSelect.addEventListener('change', () => {
            updateImageUploadVisibility();
            // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –±–ª–æ–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞
            toggleSizeSelectVisibility();
        });
    }
}

// ===== –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ =====
async function onUserImageChange(e) {
    try {
        console.log('üìÅ onUserImageChange called with files:', e.target.files?.length || 0);

        const files = Array.from(e.target.files || []);
        const errorEl = document.getElementById('userImageError');
        const preview = document.getElementById('userImagePreview');
        const previewContainer = document.getElementById('previewContainer');
        const chooseBtn = document.getElementById('chooseUserImage');
        const optionalLabel = document.querySelector('.under-user-image-label');

        // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤
        if (errorEl) errorEl.textContent = '';
        if (!files.length) {
            console.log('‚ö†Ô∏è No files selected');
            return;
        }

        console.log('üìÅ Processing', files.length, 'files for upload:', files.map(f => ({ name: f.name, size: f.size, type: f.type })));

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ (–¥–æ 4 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
        const currentCount = userImageState.images.length;
        const newCount = currentCount + files.length;
        console.log(`üéØ Current images: ${currentCount}, new total: ${newCount}`);

        if (newCount > 4) {
            if (errorEl) {
                const errorMsg = appState.translate('image_limit_error').replace('{{count}}', 4 - currentCount);
                errorEl.textContent = errorMsg;
            }
            console.warn('üö´ Too many images, remaining:', 4 - currentCount);
            return;
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
        const validFiles = [];
        let validationErrors = [];

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            console.log(`üîç Validating file ${i+1}: ${file.name} (${file.size} bytes, ${file.type})`);

            if (!CONFIG.ALLOWED_TYPES.includes(file.type)) {
                const errorMsg = `–§–∞–π–ª ${file.name}: –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç. –†–∞–∑—Ä–µ—à–µ–Ω–æ: ${CONFIG.ALLOWED_TYPES.join(', ')}`;
                console.error('‚ùå Invalid file type:', file.type);
                validationErrors.push(errorMsg);
                continue;
            }

            const maxBytes = CONFIG.MAX_IMAGE_MB * 1024 * 1024; // –ú–ë –≤ –±–∞–π—Ç—ã
            if (file.size > maxBytes) {
                const errorMsg = `–§–∞–π–ª ${file.name}: —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å ${CONFIG.MAX_IMAGE_MB} MB).`;
                console.error('‚ùå File too large:', file.size, '>', maxBytes);
                validationErrors.push(errorMsg);
                continue;
            }

            validFiles.push(file);
            console.log(`‚úÖ File ${file.name} is valid`);
        }

        if (!validFiles.length) {
            console.log('‚ùå No valid files after validation');
            if (errorEl && validationErrors.length) {
                errorEl.textContent = validationErrors[0]; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –æ—à–∏–±–∫—É
            }
            return;
        }

        console.log('‚úÖ Valid files found:', validFiles.length, '/', files.length);
        if (validationErrors.length > 0) {
            console.warn('‚ö†Ô∏è Some files were rejected:', validationErrors.length);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
        let processedCount = 0;
        let failedCount = 0;

        for (let i = 0; i < validFiles.length; i++) {
            const file = validFiles[i];

            try {
                console.log(`üì∏ Processing file ${i+1}/${validFiles.length}: ${file.name}`);

                // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ DataURL - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —á—Ç–µ–Ω–∏—è
                const dataUrl = await readFileAsDataURL(file);
                console.log(`‚úÖ File ${file.name} read as DataURL, length: ${dataUrl.length}`);

                // –ö–æ–º–ø—Ä–µ—Å—Å–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const compressed = await maybeCompressImage(
                    dataUrl,
                    CONFIG.PREVIEW_MAX_W,
                    CONFIG.PREVIEW_MAX_H,
                    CONFIG.PREVIEW_JPEG_QUALITY
                );
                console.log(`‚ú® File ${file.name} compressed, new length: ${compressed.length}`);

                // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const imageId = Date.now() + Math.random().toString(36).substr(2, 9);
                console.log(`üÜî Created imageId: ${imageId} for ${file.name}`);

                // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const imageObj = {
                    id: imageId,
                    file: file,
                    dataUrl: compressed,
                    uploadedUrl: null
                };

                userImageState.images.push(imageObj);
                console.log(`üì¶ Added to userImageState, total images: ${userImageState.images.length}`);

                // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–≤—å—é —ç–ª–µ–º–µ–Ω—Ç
                createPreviewItem(imageId, compressed, file.name);
                console.log(`üñºÔ∏è Preview created for ${file.name}`);

                processedCount++;
                console.log(`‚úÖ Successfully processed file ${i+1}: ${file.name}`);

            } catch (error) {
                console.error(`‚ùå Failed to process file ${i+1} (${file.name}):`, error);
                failedCount++;

                if (errorEl) {
                    errorEl.textContent = `–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ${file.name}: ${error.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                }
            }
        }

        console.log(`üìä Processing summary: ${processedCount} succeeded, ${failedCount} failed`);

        // –û–±–Ω–æ–≤–ª—è–µ–º UI –µ—Å–ª–∏ –µ—Å—Ç—å —É—Å–ø–µ—à–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        if (processedCount > 0) {
            console.log('üé® Updating UI for successful uploads');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            if (preview) {
                preview.classList.remove('hidden', 'flux-shnel-hidden');
                console.log('‚úÖ Preview container shown');
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã wrapper
            const wrapper = document.getElementById('userImageWrapper');
            if (wrapper) {
                wrapper.classList.add('has-image');
                wrapper.classList.remove('need-image');
                console.log('‚úÖ Wrapper classes updated');
            }

            // –û–±–Ω–æ–≤—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            toggleSizeSelectVisibility();
            updateImageUploadVisibility();

            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–∫–∞–∑—ã–≤–∞–Ω–∏–µ –ø—Ä–µ–≤—å—é
            const hasImages = userImageState.images.length > 0;
            if (preview && hasImages) {
                preview.classList.remove('flux-shnel-hidden', 'hidden');
                preview.style.setProperty('display', 'block', 'important');
                console.log('‚úÖ Forced preview visibility');
            }

            console.log(`üéØ Final state: ${userImageState.images.length} images uploaded successfully`);

            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—å—é –∏—Å—Ç–æ—Ä–∏–∏
            setTimeout(() => {
                const historyList = document.getElementById('historyList');
                if (historyList && !historyList.classList.contains('hidden')) {
                    console.log('üéØ Starting history preview force load');
                    globalHistoryLoader.forceLoadVisibleHistoryPreviews();
                }
            }, 100);

        } else {
            console.warn('‚ö†Ô∏è No files were processed successfully');
            if (errorEl && !errorEl.textContent) {
                errorEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã.';
            }
        }

    } catch (globalError) {
        console.error('üí• Global error in onUserImageChange:', globalError);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        const errorEl = document.getElementById('userImageError');
        if (errorEl) {
            errorEl.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
        }

        // –ù–µ –¥–∞–µ–º –æ—à–∏–±–∫–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–∏—Ç—å—Å—è –≤—ã—à–µ
    }
}

// ===== –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–≤—å—é —ç–ª–µ–º–µ–Ω—Ç–∞ =====
function createPreviewItem(imageId, dataUrl, fileName) {
    const previewContainer = document.getElementById('previewContainer');
    if (!previewContainer) return;

    // üëâ imageUUID –¥–æ–±–∞–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Runware –≤ generateImage()

    const itemDiv = document.createElement('div');
    itemDiv.className = 'preview-item';
    itemDiv.setAttribute('data-id', imageId);
    itemDiv.style.cssText = `
        position: relative;
        display: inline-block;
        margin: 4px;
        border: 2px solid var(--border-primary);
        border-radius: 6px;
        overflow: hidden;
        background: var(--bg-secondary);
    `;

    const img = document.createElement('img');
    img.src = dataUrl;
    img.alt = fileName;
    img.style.cssText = `
        width: 60px;
        height: 60px;
        object-fit: cover;
        display: block;
    `;

    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-preview-btn';
    removeBtn.textContent = '√ó';
    removeBtn.onclick = () => removeImage(imageId);
    removeBtn.style.cssText = `
        position: absolute;
        top: 0;
        right: 0;
        width: 16px;
        height: 16px;
        background: rgba(0,0,0,0.7);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    `;

    // –°–æ–∑–¥–∞–µ–º –º–∞–ª–µ–Ω—å–∫—É—é –∫–Ω–æ–ø–∫—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å" –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–≤—å—é
    const innerUploadBtn = document.createElement('button');
    innerUploadBtn.className = 'inner-upload-btn';
    innerUploadBtn.onclick = (e) => {
        e.preventDefault();  // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º submit —Ñ–æ—Ä–º—ã
        e.stopPropagation(); // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
        const input = document.getElementById('userImage');
        if (input) input.click();
    };

    const uploadIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    uploadIcon.setAttribute('viewBox', '0 0 24 24');
    uploadIcon.setAttribute('fill', 'none');
    uploadIcon.setAttribute('stroke', 'currentColor');
    uploadIcon.setAttribute('stroke-width', '2');

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', 'M7 16a4 4 0 01-.88-7.903A4.999 4.999 0 0111 11h1V9a4 4 0 118 4.001c0-.73-.303-1.406-.88-1.923A5.002 5.002 0 0117 7a5 5 0 11-10 0v2.097A4.001 4.001 0 017 16z');
    path.setAttribute('stroke-linecap', 'round');
    path.setAttribute('stroke-linejoin', 'round');

    const path2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path2.setAttribute('d', 'M15 19l-3-3-3 3M12 19V13');

    // Simple plus icon for upload
    const plusPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    plusPath.setAttribute('d', 'M19 11H13V17C13 17.5523 12.5523 18 12 18C11.4477 18 11 17.5523 11 17V11H5C4.44772 11 4 10.5523 4 10C4 9.44772 4.44772 9 5 9H11V3C11 2.44772 11.4477 2 12 2C12.5523 2 13 2.44772 13 3V9H19C19.5523 9 20 9.44772 20 10C20 10.5523 19.5523 11 19 11Z');
    uploadIcon.appendChild(plusPath);
    innerUploadBtn.appendChild(uploadIcon);

    itemDiv.appendChild(img);
    itemDiv.appendChild(removeBtn);
    itemDiv.appendChild(innerUploadBtn);
    previewContainer.appendChild(itemDiv);

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –º–∞–ª–µ–Ω—å–∫–æ–π –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
    setTimeout(() => updateInnerUploadButtonVisibility(), 50);
}


// ===== –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è =====
function removeImage(imageId) {
    // –£–¥–∞–ª—è–µ–º –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    userImageState.images = userImageState.images.filter(img => img.id !== imageId);

    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–≤—å—é —ç–ª–µ–º–µ–Ω—Ç
    const previewContainer = document.getElementById('previewContainer');
    const item = previewContainer?.querySelector(`[data-id="${imageId}"]`);
    if (item) item.remove();

    // –ï—Å–ª–∏ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, —Å–∫—Ä—ã—Ç—å –ø—Ä–µ–≤—å—é
    if (!userImageState.images.length) {
        const preview = document.getElementById('userImagePreview');
        if (preview) preview.classList.add('hidden');
        const wrapper = document.getElementById('userImageWrapper');
        wrapper?.classList.remove('has-image');
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ –µ—Å–ª–∏ –º–µ–Ω—å—à–µ 4
    const chooseBtn = document.getElementById('chooseUserImage');
    if (chooseBtn && userImageState.images.length < 4) {
        chooseBtn.style.display = '';
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≤—ã–±–æ—Ä–∞ —Ä–∞–∑–º–µ—Ä–æ–≤
    toggleSizeSelectVisibility();

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏ –∏ –ø—Ä–µ–≤—å—é —Å–æ–≥–ª–∞—Å–Ω–æ –ª–æ–≥–∏–∫–µ —Ä–µ–∂–∏–º–∞
    updateImageUploadVisibility();
}

// ===== –£–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–¥–ª—è —Ä–µ–∂–∏–º–∞ fast_generation) =====
function clearAllImages() {
    console.log('üóëÔ∏è Clearing ALL images for mode switch');

    // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    userImageState.images = [];

    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–≤—å—é —ç–ª–µ–º–µ–Ω—Ç—ã
    const previewContainer = document.getElementById('previewContainer');
    if (previewContainer) {
        previewContainer.innerHTML = ''; // –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    }

    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    const preview = document.getElementById('userImagePreview');
    if (preview) {
        preview.classList.add('hidden');
    }

    // –°–Ω–∏–º–∞–µ–º –∫–ª–∞—Å—Å has-image —Å wrapper
    const wrapper = document.getElementById('userImageWrapper');
    if (wrapper) {
        wrapper.classList.remove('has-image');
    }

    console.log('‚úÖ All images cleared successfully');

    // üî• –î–û–ë–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
    setTimeout(() => updateImageUploadVisibility(), 50);
}

// ===== –ù–æ–≤–æ–µ —Ñ—É–Ω–∫—Ü–∏—è: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –º–∞–ª–µ–Ω—å–∫–æ–π –∫–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–≤—å—é =====
function updateInnerUploadButtonVisibility() {
    const currentMode = document.getElementById('modeSelect').value;
    const imageCount = userImageState.images.length;
    const previewItems = document.querySelectorAll('.preview-item');

    previewItems.forEach(item => {
        const innerBtn = item.querySelector('.inner-upload-btn');
        if (!innerBtn) return;

        let shouldShowInnerBtn = false;

        if (currentMode === 'photo_session') {
            // –î–ª—è Photo Session: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ 4 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            shouldShowInnerBtn = imageCount < 4;
        } else if (['upscale_image', 'background_removal'].includes(currentMode)) {
            // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ä–µ–∂–∏–º–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ 1 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            shouldShowInnerBtn = imageCount < 1;
        }
        // –î–ª—è fast_generation: –≥–æ—Ä–µ–º –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –∫–Ω–æ–ø–∫—É (–Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ —Ä–µ–∂–∏–º–æ–≤)

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
        if (shouldShowInnerBtn) {
            innerBtn.style.display = 'flex';
            innerBtn.classList.remove('hidden');
        } else {
            innerBtn.style.display = 'none';
            innerBtn.classList.add('hidden');
        }
    });

    console.log(`üîò Inner upload button visibility updated for mode: ${currentMode}, images: ${imageCount}`);
}

// ===== –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ =====
function trimImagesToLimit(limit) {
    if (userImageState.images.length <= limit) return;

    console.log(`üóëÔ∏è Trimming images from ${userImageState.images.length} to ${limit}`);

    // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ N –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const imagesToRemove = userImageState.images.slice(limit);
    userImageState.images = userImageState.images.slice(0, limit);

    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–≤—å—é —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const previewContainer = document.getElementById('previewContainer');
    imagesToRemove.forEach(img => {
        const item = previewContainer?.querySelector(`[data-id="${img.id}"]`);
        if (item) item.remove();
    });

    console.log(`‚úÖ Trimmed ${imagesToRemove.length} excess images`);
}

// ===== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ =====


// ===== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ =====
function updateUploadButtonPosition() {
    const chooseBtn = document.getElementById('chooseUserImage');
    const preview = document.getElementById('userImagePreview');
    const container = document.getElementById('userImageWrapper');
    const hasImages = userImageState.images.length > 0;
    const hasLimitReached = userImageState.images.length >= getImageLimitForMode(document.getElementById('modeSelect')?.value || 'default');

    if (!chooseBtn || !container) return;

    // –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è
    chooseBtn.remove();

    if (hasImages && !hasLimitReached) {
        // –ï—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ò –µ—â–µ –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å - –≤—Å—Ç–∞–≤–ª—è–µ–º –≤–Ω—É—Ç—Ä—å –ø—Ä–µ–≤—å—é
        if (preview) {
            preview.appendChild(chooseBtn);

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ —Å—Ç–∏–ª—å "–≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–≤—å—é"
            chooseBtn.classList.add('inside-preview');
            chooseBtn.classList.remove('outside-upload');
            console.log('üîò –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –í–ù–£–¢–†–¨prev –ø—Ä–µ–≤—å—é');
        }
    } else if (!hasImages && !hasLimitReached) {
        // –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ò –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å - –≤—Å—Ç–∞–≤–ª—è–µ–º —Å–Ω–∞—Ä—É–∂–∏
        container.appendChild(chooseBtn);

        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ —Å—Ç–∏–ª—å "—Å–Ω–∞—Ä—É–∂–∏"
        chooseBtn.classList.add('outside-upload');
        chooseBtn.classList.remove('inside-preview');
        console.log('üîò –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –°–ù–ê–†–£–ñ–ò');
    }

    // –õ–∏–º–∏—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç - –Ω–∏–∫–∞–∫ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º (–∫–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã—Ç–∞ –≤ –ª—é–±–æ–º –ø–æ–ª–æ–∂–µ–Ω–∏–∏)
    if (hasLimitReached) {
        chooseBtn.style.display = 'none';
        console.log('üö´ –ö–Ω–æ–ø–∫–∞ –°–ö–†–´–¢–ê - –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç');
    } else {
        chooseBtn.style.display = '';
    }
}

// ===== –ü–æ–∫–∞–∑ —Ä–∞–∑–º–µ—Ä–æ–≤ =====
function toggleSizeSelectVisibility() {
    const sizeSelect = document.getElementById('sizeSelect');
    const sizeGroup = sizeSelect ? sizeSelect.closest('.form-group') : null;

    if (sizeGroup) {
        const modeSelect = document.getElementById('modeSelect');
        const currentMode = modeSelect ? modeSelect.value : '';

        // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤
        if (currentMode === 'fast_generation') {
            // –î–ª—è Flux Shnel –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ä–∞–∑–º–µ—Ä–æ–≤
            sizeGroup.style.display = '';
            console.log('üìè Size selector visible for Flux Shnel mode');
        } else if (currentMode === 'photo_session') {
            // –î–ª—è Nano Banana (photo_session) –ø—Ä—è—á–µ–º —Ä–∞–∑–º–µ—Ä –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            if (userImageState.images.length > 0) {
                sizeGroup.style.display = 'none';
                console.log('üìè Size selector hidden for Photo Session mode - has images');
            } else {
                sizeGroup.style.display = '';
                console.log('üìè Size selector visible for Photo Session mode - no images');
            }
        } else {
            // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ä–µ–∂–∏–º–æ–≤ –ø—Ä—è—á–µ–º –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            if (userImageState.images.length > 0) {
                sizeGroup.style.display = 'none';
                console.log('üìè Size selector hidden - has images in other mode');
            } else {
                sizeGroup.style.display = '';
                console.log('üìè Size selector visible - no images in other mode');
            }
        }
    }
}

// ===== –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ Runware.ai –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ UUID =====
async function uploadToRunware(dataUrl, apiKey) {
    const key = (apiKey || '').trim();
    if (!key) {
        console.warn('Runware API key missing ‚Äî skipping user image upload');
        return null;
    }

    try {
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å data:image...base64, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç —á–∏—Å—Ç—ã–π base64)
        const base64Image = String(dataUrl).replace(/^data:image\/[a-z]+;base64,/, '');

        const taskUUID = generateUUIDv4();
        console.log('üì§ Starting Runware upload:', { taskUUID, base64Length: base64Image.length });

        const requestData = {
            taskType: 'imageUpload',
            taskUUID: taskUUID,
            image: base64Image
        };

        console.log('üì§ Runware request data (preview):', {
            taskType: requestData.taskType,
            taskUUID: requestData.taskUUID,
            imagePreview: requestData.image.substring(0, 50) + '...'
        });

        // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: API —Ç—Ä–µ–±—É–µ—Ç –ú–∞—Å—Å–∏–≤, –∞ –Ω–µ –æ–±—ä–µ–∫—Ç!
        const requestArray = [requestData];

        console.log('üì§ Runware request ARRAY format:', {
            arrayLength: requestArray.length,
            firstRequestType: requestArray[0]?.taskType
        });

        const response = await fetch('https://api.runware.ai/v1/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': `Bearer ${key}`
            },
            body: JSON.stringify(requestArray) // üî• –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ú–ê–°–°–ò–í!
        });

        console.log('üì• Runware response status:', response.status);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Runware upload failed:', {
                status: response.status,
                statusText: response.statusText,
                body: errorText
            });

            // –†–∞–∑–±–æ—Ä –æ—à–∏–±–∫–∏ –¥–ª—è –ª—É—á—à–µ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            try {
                const errorJson = JSON.parse(errorText);
                if (errorJson.errors && errorJson.errors[0]) {
                    const firstError = errorJson.errors[0];
                    console.error('‚ùå Runware API error details:', {
                        message: firstError.message,
                        code: firstError.extensions?.code || firstError.code,
                        type: firstError.type
                    });

                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
                    if (firstError.extensions?.code === 'UNAUTHENTICATED' ||
                        firstError.message?.includes('API key')) {
                        console.warn('üîë Problem with API key - check RUNWARE_API_KEY config');
                    } else if (firstError.message?.includes('image') ||
                               firstError.message?.includes('base64')) {
                        console.warn('üñºÔ∏è Problem with image format - check base64 encoding');
                    }
                }
            } catch (parseError) {
                console.error('‚ùå Cannot parse error response:', errorText);
            }

            return null;
        }

        const result = await response.json();
        console.log('‚úÖ Runware upload response:', result);

        // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –≤ data, –∞ –Ω–µ –ø—Ä—è–º–æ–π –æ–±—ä–µ–∫—Ç
        if (result.data && Array.isArray(result.data) && result.data[0] && result.data[0].imageUUID) {
            console.log('‚úÖ Image uploaded to Runware, UUID:', result.data[0].imageUUID);
            return result.data[0].imageUUID;
        } else {
            console.error('‚ùå Runware response missing imageUUID in array:', result);
            return null;
        }
    } catch (error) {
        console.error('‚ùå Runware upload error:', error);
        return null;
    }
}

// ===== –£–î–ê–õ–ï–ù: IMGBB –ó–ê–ì–†–£–ó–ö–ê - –ø–æ–ª–Ω–æ—Å—Ç—å –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ Runware.ai =====
// –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è uploadToImgbb —É–¥–∞–ª–µ–Ω–∞ - —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ Runware UUID

// –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø –° Runware –í –ü–†–ò–û–†–ò–¢–ï–¢–ï
async function uploadUserImages() {
    const images = userImageState.images;
    console.log('üöÄ Starting uploadUserImages process with Runware priority:', {
        totalImages: images ? images.length : 0,
        hasImages: !!images && images.length > 0,
        runwareKey: !!(CONFIG.RUNWARE_API_KEY && CONFIG.RUNWARE_API_KEY.trim()),
        imgbbKeyFallback: !!(CONFIG.IMGBB_API_KEY && CONFIG.IMGBB_API_KEY.trim())
    });

    if (!images || images.length === 0) {
        console.log('‚ùå No images to upload, returning empty array');
        return [];
    }

    const uuids = []; // –¢–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ–º UUID –≤–º–µ—Å—Ç–æ URL

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º RUNWARE
    const uploadPromises = images.map(async (image, index) => {
        console.log(`üéØ Processing image ${index + 1}/${images.length}:`, {
            hasDataUrl: !!image.dataUrl,
            hasUploadedUUID: !!image.uploadedUUID,
            hasUploadedUrl: !!image.uploadedUrl, // legacy fallback
            fileName: image.file?.name || 'unknown'
        });

        if (!image.dataUrl && !image.uploadedUrl) {
            console.warn(`‚ö†Ô∏è Image ${index + 1} has no dataUrl or uploadedUrl`);
            return null;
        }

        // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ UUID (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        if (image.uploadedUUID) {
            console.log(`‚úÖ Image ${index + 1} already uploaded UUID: ${image.uploadedUUID}`);
            return image.uploadedUUID;
        }

        // –ï—Å–ª–∏ –µ—Å—Ç—å legacy URL, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ UUID –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        if (image.uploadedUrl && typeof image.uploadedUrl === 'string') {
            console.log(`üîÑ Image ${index + 1} using legacy URL as UUID: ${image.uploadedUrl.substring(0, 36)}...`);
            image.uploadedUUID = image.uploadedUrl; // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º legacy
            return image.uploadedUrl;
        }

        try {
            // –ü–†–ò–û–†–ò–¢–ï–¢ RUNWARE - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π API
            if (CONFIG.RUNWARE_API_KEY && CONFIG.RUNWARE_API_KEY.trim()) {
                console.log(`üì§ [PRIORITY] Uploading image ${index + 1} to Runware...`);
                const uuid = await uploadToRunware(image.dataUrl, CONFIG.RUNWARE_API_KEY);
                if (uuid) {
                    image.uploadedUUID = uuid; // –°–æ—Ö—Ä–∞–Ω—è–µ–º UUID
                    console.log(`‚úÖ Runware upload success for image ${index + 1}, UUID: ${uuid}`);
                    return uuid;
                }
            }

            console.error(`‚ùå Runware upload failed for image ${index + 1} - no fallback available`);
            return null;

        } catch (error) {
            console.error(`‚ùå Upload entirely failed for image ${index + 1}:`, error);
            return null;
        }
    });

    // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    console.log('‚è≥ Waiting for all uploads to complete...');
    const uploadedResults = await Promise.all(uploadPromises);
    console.log('‚úÖ All upload promises resolved');

    // –§–∏–ª—å—Ç—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏
    const successfulResults = uploadedResults.filter(result => result !== null);
    console.log('üéØ Upload results summary:', {
        total: images.length,
        successful: successfulResults.length,
        failed: images.length - successfulResults.length,
        hasRunwareResults: successfulResults.some(uuid => typeof uuid === 'string' && uuid.length > 10 && !uuid.includes('http')),
        results: successfulResults.slice(0, 3).map(r => typeof r === 'string' ? r.substring(0, 20) + '...' : r)
    });

    return successfulResults;
}

// üì± Telegram WebApp Integration - –£–î–ê–õ–ï–ù–ê: –¥—É–±–ª–∏—Ä—É—é—â–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –≤ services.js

function initLanguageDropdown() {
    const btn = document.getElementById('langBtn');
    const menu = document.getElementById('langMenu');
    if (!btn || !menu) return;

    // –ö–∞—Ä—Ç–∞ —è–∑—ã–∫–æ–≤ —Å —Ñ–ª–∞–≥–∞–º–∏ –∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
    const languageMap = {
        'en': { flag: 'üá∫üá∏', name: 'English' },
        'ru': { flag: 'üá∑üá∫', name: '–†—É—Å—Å–∫–∏–π' },
        'es': { flag: 'üá™üá∏', name: 'Espa√±ol' },
        'fr': { flag: 'üá´üá∑', name: 'Fran√ßais' },
        'de': { flag: 'üá©üá™', name: 'Deutsch' },
        'zh': { flag: 'üá®üá≥', name: '‰∏≠Êñá' },
        'pt': { flag: 'üáßüá∑', name: 'Portugu√™s' },
        'ar': { flag: 'üá∏üá¶', name: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' },
        'hi': { flag: 'üáÆüá≥', name: '‡§π‡§ø‡§Ç‡§¶‡•Ä' },
        'ja': { flag: 'üáØüáµ', name: 'Êó•Êú¨Ë™û' },
        'it': { flag: 'üáÆüáπ', name: 'Italiano' },
        'ko': { flag: 'üá∞üá∑', name: 'ÌïúÍµ≠Ïñ¥' },
        'vi': { flag: 'üáªüá≥', name: 'Ti·∫øng Vi·ªát' },
        'th': { flag: 'üáπüá≠', name: '‡πÑ‡∏ó‡∏¢' },
        'tr': { flag: 'üáπüá∑', name: 'T√ºrk√ße' },
        'pl': { flag: 'üáµüá±', name: 'Polski' }
    };

    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –º–µ–Ω—é —è–∑—ã–∫–∞–º–∏
    menu.innerHTML = '';
    CONFIG.LANGUAGES.forEach(l => {
        const li = document.createElement('li');
        const langInfo = languageMap[l] || { flag: l, name: l };
        li.innerHTML = `<span class="flag">${langInfo.flag}</span> <span class="lang-name">${langInfo.name}</span>`;
        li.dataset.lang = l; // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–¥ —è–∑—ã–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞

        li.addEventListener('click', (evt) => {
            evt.stopPropagation();
            appState.setLanguage(l);        // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage —á–µ—Ä–µ–∑ saveSettings()
            menu.style.display = 'none';    // —Å–∫—Ä—ã—Ç—å –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
        });
        menu.appendChild(li);
    });

    // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–æ (–¥—É–±–ª–∏—Ä—É–µ–º CSS –Ω–∞ —Å–ª—É—á–∞–π –∑–∞–¥–µ—Ä–∂–∫–∏ —Å—Ç–∏–ª–µ–π)
    menu.style.display = 'none';

    // –û—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å –ø–æ –∫–Ω–æ–ø–∫–µ
    btn.addEventListener('click', (evt) => {
        evt.stopPropagation();
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    });

    // –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
    document.addEventListener('click', (evt) => {
        if (!menu.contains(evt.target) && !btn.contains(evt.target)) {
            menu.style.display = 'none';
        }
    });

    // –ó–∞–∫—Ä—ã—Ç—å –ø–æ Esc
    document.addEventListener('keydown', (evt) => {
        if (evt.key === 'Escape') {
            menu.style.display = 'none';
        }
    });

    console.log('üåç Language dropdown initialized with flags and names');
}

// üöÄ App Initialization
document.addEventListener('DOMContentLoaded', async function () {
    console.log('üöÄ pixPLace Creator starting...');

    // üî• AUTO-UPDATE MAINTENANCE.JS CONFIG FILE (–î–ï–ú–û –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø)
    try {
        // –û–±–Ω–æ–≤–ª—è–µ–º maintenance.js —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º CONFIG.MAINTENANCE_MODE - –ø—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–º–∞—Ç
        const newConfig = `// Config for maintenance mode
const MAINTENANCE_MODE = ${CONFIG.MAINTENANCE_MODE}; // Auto-updated: ${new Date().toISOString()}`;

        console.log('üîß Maintenance mode config updated:', CONFIG.MAINTENANCE_MODE, '- remember to sync maintenance.js');
        // NOTE: –í –ø—Ä–æ–¥–µ —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ–ª–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ API
        // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä—É—á–Ω—É—é –≤—Å—Ç–∞–≤—å—Ç–µcontent –≤—ã—à–µ –≤ maintenance.js

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ maintenance.html
        window.CONFIG_MAINTENANCE_MODE = CONFIG.MAINTENANCE_MODE;
        window.MAINTENANCE_MODE_LAST_UPDATE = new Date().toISOString();
    } catch (error) {
        console.warn('‚ùå Maintenance config update error:', error);
    }

    // üöß –ü–†–û–í–ï–†–ö–ê –†–ï–ñ–ò–ú–ê –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–Ø - –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ maintenance.html
    if (CONFIG.MAINTENANCE_MODE) {
        console.log('üöß Maintenance Mode enabled - redirecting to maintenance page');
        window.location.href = 'maintenance.html';
        return; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
    }

    showLoadingScreen();

    // ‚ùÑÔ∏è –°–ù–ï–ì–û–ü–ê–î –ù–ê–ß–ò–ù–ê–ï–¢–°–Ø –°–†–ê–ó–£ –ü–û–°–õ–ï –ü–û–ö–ê–ó–ê –õ–û–ê–î–≠–†–ê!
    startSnowfall();
    console.log('‚ùÑÔ∏è Snowfall started immediately - right after loading screen');

    // üî• –ù–û–í–û–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Ä–≤–∏—Å—ã –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ appState
    const services = await initializeGlobalServices();

    let telegramInitialized = false;

    try {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        telegramInitialized = await services.telegram.initialize(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram
        console.log('üì± Telegram initialization result:', telegramInitialized);
    } catch (error) {
        console.error('‚ùå Telegram initialization error:', error);
        telegramInitialized = false;
    }

    console.log('üîÑ Eureka Branch:', telegramInitialized ? 'TELEGRAM OK' : 'SHOW AUTH (or TESTING without auth)');
    if (!telegramInitialized && !BYPASS_AUTH) {
        // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: –ï—Å–ª–∏ Telegram –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ù–ï–ú–ï–î–õ–ï–ù–ù–û
        console.log('‚ö†Ô∏è Telegram not available - PROCEEDING WITHOUT AUTH (TEMPORARILY DISABLED)');

        // –í–†–ï–ú–ï–ù–ù–û –ü–†–û–î–û–õ–ñ–ê–ï–ú –ë–ï–ó –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
        // // –ò–º–ø–æ—Ä—Ç –∏ –≤—ã–∑–æ–≤ ScreenManager.show
        // // const screenManagerModule = await import('./screen-manager.js');
        // // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ ScreenManager
        // // ScreenManager.showAuth();

        // –°–∫—Ä—ã–≤–∞–µ–º loading screen
        hideLoadingScreen();

        // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (legacy support)
        window.appState = services.appState;
        console.log('‚úÖ Services initialized, appState bridged for compatibility');

        initializeUI();
        initUserImageUpload();
        initLanguageDropdown();

        // –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ screen-manager.js —á–µ—Ä–µ–∑ ScreenManager
        console.log('‚úÖ User Account initialization handled in screen-manager.js');

        const carouselImages = document.querySelectorAll('.carousel-2d-item img');
        carouselImages.forEach(img => {
            img.loading = 'lazy';
            img.decoding = 'async';
        });

        // üî• –¢–û–ß–ù–´–ô –ö–û–ù–¢–†–û–õ–¨: –ù–ï–ú–ï–î–õ–ï–ù–ù–û - –ø–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–∫–æ–ª—å–∫—É Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        const finishLoading = () => {
            hideLoadingScreen();
            showAuth();
            initAICoach();
            console.log('‚úÖ –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω —Å–∫—Ä—ã—Ç - –ø–æ–∫–∞–∑–∞–Ω —ç–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
        };

        // –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê - –±–µ–∑ —Ç–∞–π–º–∞—É—Ç–∞!
        console.log('‚è≥ –ù–∞—á–∏–Ω–∞–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞');
        finishLoading();

    } else {
        // Telegram –¥–æ—Å—Ç—É–ø–µ–Ω - –æ–±—ã—á–Ω—ã–π –ø–æ—Ç–æ–∫

        // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (legacy support)
        window.appState = services.appState;
        console.log('‚úÖ Services initialized, appState bridged for compatibility');

        initializeUI();
        initUserImageUpload();
        initLanguageDropdown();
        // –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ screen-manager.js —á–µ—Ä–µ–∑ ScreenManager
        console.log('‚úÖ User Account initialization handled in screen-manager.js');

        const carouselImages = document.querySelectorAll('.carousel-2d-item img');
        carouselImages.forEach(img => {
            img.loading = 'lazy';
            img.decoding = 'async';
        });

        // üî• –¢–û–ß–ù–´–ô –ö–û–ù–¢–†–û–õ–¨: 2 –°–ï–ö–£–ù–î–´ - –î–û–°–¢–ê–¢–û–ß–ù–û –î–õ–Ø –ó–ê–í–ï–†–®–ï–ù–ò–Ø –ê–ù–ò–ú–ê–¶–ò–ô
        const finishLoading = () => {
            hideLoadingScreen();
            showApp();
            updateUserBalanceDisplay(appState.userCredits);
            updateUserNameDisplay(); // üî• –î–û–ë–ê–í–õ–ï–ù–û: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            initAICoach();
            console.log('‚úÖ –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω —Å–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã - –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫');
        };

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ç–∞–π–º–∞—É—Ç 2 —Å–µ–∫—É–Ω–¥—ã - –∞–Ω–∏–º–∞—Ü–∏–π —Ö–≤–∞—Ç–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è
        console.log('‚è≥ –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å—á–µ—Ç 2 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π');
        setTimeout(finishLoading, 2000);
    }
});



// üñºÔ∏è Image Generation - –û–ë–ù–û–í–õ–ï–ù–û –î–õ–Ø –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û–ô –ì–ï–ù–ï–†–ê–¶–ò–ò
async function generateImage(event) {
    if (event) {
        event.preventDefault();
    }

    // –î–æ–±–∞–≤–ª—è–µ–º taskUUID –¥–ª—è –≤—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    const taskUUID = generateUUIDv4();

    const prompt = document.getElementById('promptInput').value.trim();
    const mode = document.getElementById('modeSelect').value;
    const size = document.getElementById('sizeSelect').value;

    // üö® –≠–ö–°–¢–†–ï–ù–ù–´–ô –õ–û–ì–ò–ù–ì: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–Ω–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    const checkedMode = document.getElementById('modeSelect').value;
    console.log('üö® ULTIMATE MODE CHECK - document.getElementById("modeSelect").value:', checkedMode);
    if (checkedMode !== mode) {
        console.error('üö® MODE MISMATCH! Function param:', mode, 'vs DOM value:', checkedMode);
        mode = checkedMode; // –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω
    }

    console.log('üöÄ Starting generation:', { prompt, style: appState.selectedStyle, mode, size });

    // üîß –î–û–ë–ê–í–õ–ï–ù–ò–ï: –õ–æ–≥–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    const modeSelect = document.getElementById('modeSelect');
    console.log('üîç Mode select debug:', {
        selectedValue: modeSelect?.value,
        selectedText: modeSelect?.selectedOptions[0]?.textContent?.trim(),
        selectedIndex: modeSelect?.selectedIndex,
        allOptions: Array.from(modeSelect?.options || []).map(opt => ({
            value: opt.value,
            text: opt.textContent?.trim(),
            selected: opt.selected
        }))
    });

    // üîß –î–û–ë–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä–∏–º userImageState
    console.log('üîç User image state:', {
        hasImages: userImageState?.images?.length || 0,
        hasDataUrl: !!(userImageState?.images?.[0]?.dataUrl),
        hasUploadedUrl: !!(userImageState?.images?.[0]?.uploadedUrl)
    });

    // Validation
    // –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ background_removal (—É–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ–Ω–∞) –∏ upscale_image (—É–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞)
    if (mode !== 'background_removal' && mode !== 'upscale_image') {
        if (!prompt) {
            showToast('error', appState.translate('error_prompt_required'));
            triggerHaptic('error');
            return;
        }

        if (prompt.length < 5) {
            showToast('error', appState.translate('error_prompt_too_short'));
            triggerHaptic('error');
            return;
        }
    }

    if (!CONFIG.WEBHOOK_URL || CONFIG.WEBHOOK_URL.includes('WEBHOOK')) {
        showToast('error', appState.translate('error_webhook_not_configured'));
        return;
    }

    // === GUARD: upscale, background_removal —Ç—Ä–µ–±—É—é—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ ===
    // photo_session —Ç–µ–ø–µ—Ä—å –≥–∏–±—Ä–∏–¥–Ω—ã–π —Ä–µ–∂–∏–º (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å/–±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
    const requiresImage = ['upscale_image', 'background_removal'].includes(mode);
    if (requiresImage) {
        const wrapper = document.getElementById('userImageWrapper');
        const hasLocalImage = userImageState?.images && userImageState.images.length > 0;

        if (!hasLocalImage) {
            wrapper?.classList.add('need-image');
            const messageKey = mode === 'upscale_image'
                ? 'please_upload_for_upscale'
                : mode === 'background_removal'
                    ? 'please_upload_for_background_removal'
                    : 'please_upload_photo_session';
            showToast('error', appState.translate(messageKey));
            triggerHaptic('error');
            return; // –Ω–µ –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∏ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º webhook
        }
    }

    appState.startTime = Date.now();

    // Create generation record
    // üëâ –ë–µ—Ä—ë–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ –∫–∞—Ä—É—Å–µ–ª–∏ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å
    const activeCard = document.querySelector('.carousel-2d-item.active');
    const currentStyle = (activeCard?.dataset.style || '').toLowerCase();
    appState.selectedStyle = currentStyle || appState.selectedStyle;

    const generation = {
        id: Date.now(),
        taskUUID: taskUUID,
        imageUUIDs: userImageState.images.map(img => img.uploadedUUID).filter(uuid => uuid),
        prompt: prompt,
        style: appState.selectedStyle,
        mode: mode,
        size: size,
        timestamp: new Date().toISOString(),
        status: 'pending'
    };

    // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ë–û–õ–¨–®–ï –ù–ï –î–û–ë–ê–í–õ–Ø–ï–ú GENERATION –í –ò–°–¢–û–†–ò–Æ –ó–î–ï–°–¨ - –¢–û–õ–¨–ö–û –ü–†–ï–í–¨–Æ CARDS
    // –¢–µ–ø–µ—Ä—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—é –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ parallel-generation.js
    console.log('üóÇÔ∏è History storage STARTED EARLY - adding to history NOW, result deferred - GEN:', generation.id);

    // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´: –ù–ï –î–û–ë–ê–í–õ–Ø–ï–ú –í –ò–°–¢–û–†–ò–Æ –°–†–ê–ó–£!
    // –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ –ø—Ä–µ–≤—å—é –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏, –∏—Å—Ç–æ—Ä–∏—è –¥–æ–±–∞–≤–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º compleition
    console.log('üìã Generation object created, history will be added only on successful completion');

    setTimeout(() => {
        console.log('üöÄ Starting preview creation in generateImage (FORCED TO HISTORY) - GEN:', generation.id);

        const historyList = document.getElementById('historyList');
        const historyBtn = document.getElementById('historyToggleBtn');

        console.log('‚úÖ Elements found - historyList:', !!historyList, 'historyBtn:', !!historyBtn);

        // üìç 2. –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–≤—å—é —ç–ª–µ–º–µ–Ω—Ç
        console.log('üîß Calling createLoadingHistoryItem...');
        const previewItem = createLoadingHistoryItem(generation);
        console.log('‚úÖ Preview item created:', previewItem ? 'SUCCESS' : 'FAILED', previewItem);

        // üìç –ü–†–û–í–ï–†–ö–ê: –ï—Å—Ç—å –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –≤ DOM –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è?
        const checkElement = document.getElementById(`loading-${generation.id}`);
        console.log('üîç Check - element exists in DOM:', !!checkElement);
        if (checkElement) {
            console.log('üéØ Element DOM details:', {
                id: checkElement.id,
                className: checkElement.className,
                parent: checkElement.parentElement?.id,
                childrenCount: checkElement.children?.length
            });
        }

        // üìç 3. –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –±—ã–ª–∞ –∑–∞–∫—Ä—ã—Ç–∞ –° –ü–†–û–í–ï–†–ö–û–ô –ù–ê –ü–û–ó–ò–¶–ò–Æ
        let wasHidden = false;
        if (historyList && historyList.classList.contains('hidden')) {
            wasHidden = true;
            console.log('üìÇ History was hidden, opening it...');
            toggleHistoryList(); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        } else {
            console.log('üìÇ History already open - keeping position and scroll!');
            // –ù–ï –û–ë–ù–û–í–õ–Ø–ï–ú –¥–∏—Å–ø–ª–µ–π - —á—Ç–æ–±—ã –ø–æ–∑–∏—Ü–∏—è –∏ —Å–∫—Ä–æ–ª–ª –Ω–µ —Å–±—Ä–æ—Å–∏–ª–∏—Å—å!
        }

        // üìç 4. –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –ü–†–û–ö–†–£–¢–ö–ê –ö –ù–û–í–û–ú–£ –ü–†–ï–í–¨–Æ
        setTimeout(() => {
            const finalElement = document.getElementById(`loading-${generation.id}`);
            console.log('üéØ Scrolling attempt - element exists:', !!finalElement);

            if (finalElement) {
                console.log('üéØ Final scroll to preview:', finalElement.id);
                finalElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center',
                    inline: 'nearest'
                });
                console.log('üìã Scrolled to new preview successfully');
            } else {
                console.error('‚ùå Preview element NOT found for scrolling, generation:', generation.id);
                // ‚ò†Ô∏è –≠–ö–°–¢–†–ï–ù–ê–Ø –ú–ï–†–ê: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
                const emergencyPreview = createLoadingHistoryItem(generation);
                if (emergencyPreview) {
                    emergencyPreview.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center',
                        inline: 'nearest'
                    });
                    console.log('üö® Emergency scroll to recreated element');
                }
            }
        }, 300); // –ñ–¥–µ–º –æ—Ç–∫—Ä—ã—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏

        console.log('üìã Generation preview flow completed for:', generation.id);
    }, 100);

    // === –ü–†–ï–î–ü–ê–†–û–î–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –¥–ª—è photo_session –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ===
    if (mode === 'photo_session' && userImageState.images.length === 0) {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        const shouldContinue = await showWarningAboutNoImage();
        if (!shouldContinue) {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ—à–∏–ª –¥–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ - –º–æ—Ä–≥–∞–µ—Ç –∫–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
            startUploadButtonBlink();
            showGeneration();
            return; // –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º webhook
        }
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (text-to-image —Ä–µ–∂–∏–º)
    }

    startTimer();

    // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–ò:
    // 1) –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
    // 2) –¢–æ–ª—å–∫–æ –ü–†–ò –£–°–ü–ï–•–ï –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ–±–∞–≤–ª—è–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≤ –º–µ–Ω–µ–¥–∂–µ—Ä

    const imageUploadSuccess = await (async () => {
        // 1) –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äî –∑–∞–≥—Ä—É–∑–∏–º –≤—Å–µ –Ω–∞ Runware –∫–∞–∫ PRIORITY
        if (userImageState.images.length > 0) {
            try {
                console.log('üöÄ Starting Runware image upload process with priority + fallback');

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é uploadUserImages (—Ç–µ–ø–µ—Ä—å —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º Runware)
                const imageIds = await uploadUserImages(); // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç UUID –∏–ª–∏ URL legacy

                if (imageIds && imageIds.length > 0) {
                    // –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ imageUUIDs - —ç—Ç–æ —Ç–µ–ø–µ—Ä—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç
                    generation.imageUUIDs = imageIds;
                    console.log('‚úÖ Image upload successful, UUIDs ready for webhook:', imageIds.length, 'images');

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                    const hasRunwareUUIDs = imageIds.some(uuid => typeof uuid === 'string' && uuid.length === 36 && uuid.includes('-'));
                    const hasLegacyURLs = imageIds.some(url => typeof url === 'string' && url.includes('http'));

                    if (hasRunwareUUIDs) {
                        console.log('üéØ Using Runware UUIDs (modern format)');
                    } else if (hasLegacyURLs) {
                        console.log('‚ö†Ô∏è Using legacy imgbb URLs (fallback mode)');
                        // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å—Ç–∞—Ä–æ–º –ø–æ–ª–µ —Ç–æ–∂–µ
                        generation.userImageUrls = imageIds;
                    }

                    return true; // üîí –£–°–ü–ï–®–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê
                } else {
                    console.warn('‚ö†Ô∏è No images uploaded successfully');
                    return false;
                }
            } catch (err) {
                console.warn('‚ùå User images upload completely failed:', err);
                const errorEl = document.getElementById('userImageError');
                if (errorEl && !errorEl.textContent) {
                    errorEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü—Ä–æ–¥–æ–ª–∂–∏–º –±–µ–∑ –Ω–∏—Ö.';
                }
                return false; // üîí –ù–ï–£–î–ê–ß–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê
            }
        } else {
            console.log('üì∑ No user images selected, proceeding with text-to-image');
            return true; // üîí –ù–ï–¢ –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô - –û–ö
        }
    })();

    // 2) –î–æ–±–∞–≤–ª—è–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ (–∏–ª–∏ –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ—Ç –≤–æ–æ–±—â–µ)
    if (imageUploadSuccess) {
        console.log('üöÄ Proceeding with generation after successful image upload');

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        const added = generationManager.addGeneration(generation);
        if (!added) {
            console.log('‚è≥ Generation added to queue');
            // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—Å—Ç "–≤ –æ—á–µ—Ä–µ–¥–∏" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Å–æ–º–Ω–µ–Ω–∏–∏
        } else {
            console.log('üöÄ Generation started immediately');
            // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—Å—Ç "–Ω–∞—á–∞—Ç–∞" - –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω —Ç–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞
        }

        // üî• –û–¢–ú–ï–ù–ï–ù–û: –ù–ï –î–û–ë–ê–í–õ–Ø–ï–ú –í –ò–°–¢–û–†–ò–Æ –ó–î–ï–°–¨
        // –¢–µ–ø–µ—Ä—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—é –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        console.log('üì¶ Generation object ready, will be stored only on completion');
    } else {
        console.error('‚ùå Image upload failed - generation cancelled');
        showToast('error', 'Image upload failed. Generation cancelled.');
        stopTimer();
        showGeneration();
    }
}
// üåê Webhook Communication
async function sendToWebhook(data) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

    // LOG RAW REQUEST BODY FOR DEBUGGING
    const requestData = {
        ...data,
        prompt: sanitizeJsonString(data.prompt) // Restore sanitize for JSON safety
    };

    const requestBody = JSON.stringify(requestData);
    console.log('üì§ RAW webhook request body (first 500 chars):', requestBody.substring(0, 500));

    try {
        console.log('üì§ Sending webhook request:', {
            ...data,
            prompt: data.prompt.substring(0, 100) + (data.prompt.length > 100 ? '...' : '') // –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–æ–º–ø—Ç–∞
        });

        const response = await fetch(CONFIG.WEBHOOK_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: requestBody, // Use raw JSON.stringify, remove sanitizeJsonString
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        console.log('üì• Webhook response status:', response.status, response.statusText);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º Content-Type
        const contentType = response.headers.get('content-type');
        console.log('üìÑ Response content-type:', contentType);

        let result;
        try {
            const responseText = await response.text();
            console.log('üìÑ FULL RAW response text (first 1000 chars):', responseText.substring(0, 1000));
            console.log('üìÑ Response length:', responseText.length);
            console.log('üìÑ HTTP Status Code:', response.status);
            console.log('üìÑ All Response Headers:', Object.fromEntries(response.headers.entries()));

            // üî• –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï: –ü–∞—Ä—Å–∏–º –∫–∞–∫ JSON –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
            try {
                const possibleJson = JSON.parse(responseText);
                console.log('üîç POSSIBLE PARSED JSON STRUCTURE:', possibleJson);
                console.log('üîç JSON keys:', Object.keys(possibleJson));
            } catch (parseError) {
                console.log('üîç NOT VALID JSON - possibly text/html response from Make.error');
            }

            // üî• –ü–†–û–í–ï–†–ö–ê –ù–ê –°–ï–†–í–ï–†–û–ú–ï–†–û–í–ê–ù–õ–£–Æ –ü–ï–†–ï–ì–†–£–ó–ö–£ –ü–ï–†–ï–î JSON –ü–ê–†–°–ò–ù–ì–û–ú
            if (responseText.trim().toLowerCase() === 'accepted') {
                console.log('üö® SERVER OVERLOADED: Backend returned "accepted" instead of JSON');
                result = { server_overloaded: true, message: appState.translate('error_server_overloaded') };
                return result; // üî• –ù–ï–ú–ï–î–õ–ï–ù–ù–û –í–û–ó–í–†–ê–©–ê–ï–ú - –ù–ï –ü–†–û–î–û–õ–ñ–ê–ï–ú –û–ë–†–ê–ë–û–¢–ö–£
            }

            // üî• –î–û–ë–ê–í–ò–õ–ò –ü–†–û–í–ï–†–ö–£ –ù–ê –î–†–£–ì–ò–ï –¢–ï–ö–°–¢–û–í–´–ï –û–¢–í–ï–¢–´ –ü–ï–†–ï–ì–†–£–ó–ö–ò
            if (responseText.trim().includes('overload') || responseText.trim().includes('busy') ||
                responseText.trim().includes('maintenance') || responseText.trim().includes('timeout')) {
                console.log('üö® SERVER OVERLOADED: Detected overload keywords in response');
                result = { server_overloaded: true, message: appState.translate('error_server_overloaded') };
                return result;
            }

            if (contentType && contentType.includes('application/json')) {
                result = JSON.parse(responseText);
                console.log('‚úÖ Parsed webhook response as JSON:', result);
            } else if (contentType && contentType.includes('text/')) {
                // –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª —Ç–µ–∫—Å—Ç (–Ω–µ JSON –∏ –Ω–µ "accepted")
                console.log('üìÑ Server returned text:', responseText);
                throw new Error('Server returned text instead of JSON: ' + responseText);
            } else {
                // –ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π content-type ‚Äî –ø—ã—Ç–∞–µ–º—Å—è —Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
                console.log('üìÑ Unexpected content-type, trying to parse as JSON:', responseText);
                try {
                    result = JSON.parse(responseText);
                    console.log('‚úÖ Fallback: parsed as JSON despite content-type');
                } catch (parseError) {
                    console.error('‚ùå Failed to parse response as JSON:', responseText);
                    throw new Error('Server returned invalid format: ' + responseText.substring(0, 100));
                }
            }
        } catch (error) {
            console.error('‚ùå Response processing error:', error);
            if (error instanceof SyntaxError) {
                throw new Error('Server returned malformed JSON');
            }
            throw error;
        }

        console.log('‚úÖ Final processed webhook response:', result);
        return result;

    } catch (error) {
        clearTimeout(timeoutId);

        if (error.name === 'AbortError') {
            throw new Error(appState.translate('error_timeout'));
        }

        // –î–û–ë–ê–í–õ–ï–ù–ò–ï: –î–µ—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            throw new Error('Connection failed. Check your internet connection and try again.');
        }

        // –î–û–ë–ê–í–õ–ï–ù–ò–ï: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–µ—Ç–∏ –∏ CORS
        if (error.name === 'NetworkError' || error.message.includes('network') || error.message.includes('CORS')) {
            throw new Error('Network error. Please check your connection and try again.');
        }

        console.error('‚ùå Webhook error:', error);
        throw error;
    }
}
// üé® Style Selection
//  2D Carousel (loop, Android-friendly)
(() => {
    // –ù–∞—Ö–æ–¥–∏–º —Ç—Ä–µ–∫ –ø–æ id –∏–ª–∏ –ø–æ –∫–ª–∞—Å—Å—É
    const track = document.getElementById('carousel2d') || document.querySelector('.carousel-2d');
    if (!track) { console.warn('[carousel2d] —Ç—Ä–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
    if (track._carouselInited) return; // –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    track._carouselInited = true;

    const cards = Array.from(track.querySelectorAll('.carousel-2d-item'));
    if (!cards.length) { console.warn('[carousel2d] –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'); return; }

    let selectedStyle = (cards[0].dataset.style || '').toLowerCase();
    let isPointerDown = false;
    let isPointerInteracting = false;
    let isHighlighting = false;
    let moved = false;
    let startX = 0, startY = 0, startScroll = 0;

    // ===== helpers =====
    function updateGutters() {
        const cardW = cards[0]?.offsetWidth || 0;
        const viewport = track.clientWidth || 0;
        if (!cardW || !viewport) return;
        const gutter = Math.max(0, (viewport - cardW) / 2);
        track.style.paddingLeft = `${gutter}px`;
        track.style.paddingRight = `${gutter}px`;
    }

    function centerCard(card, smooth = true) {
        if (!card) return;
        const viewport = track.clientWidth;
        const left = card.offsetLeft - (viewport - card.offsetWidth) / 2;
        const maxScroll = track.scrollWidth - viewport;
        const clamped = Math.max(0, Math.min(left, maxScroll));
        track.scrollTo({ left: clamped, behavior: smooth ? 'smooth' : 'auto' });
    }

    function highlight(card, { scroll = false } = {}) {
        cards.forEach(c => c.classList.remove('active'));
        if (!card) return;
        card.classList.add('active');

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–∏–ª—å
        selectedStyle = (card.dataset.style || '').toLowerCase();
        if (window.appState) window.appState.selectedStyle = selectedStyle;

        // –°–æ–æ–±—â–∞–µ–º –Ω–∞—Ä—É–∂—É (–µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ —Å–ª—É—à–∞–µ—Ç)
        document.dispatchEvent(new CustomEvent('style:change', { detail: { style: selectedStyle } }));

        if (scroll) centerCard(card, true);
    }

    function nearestCard() {
        const trackRect = track.getBoundingClientRect();
        const centerX = trackRect.left + trackRect.width / 2;
        let best = null, bestDist = Infinity;
        for (const c of cards) {
            const r = c.getBoundingClientRect();
            const cardCenter = r.left + r.width / 2;
            const dist = Math.abs(cardCenter - centerX);
            if (dist < bestDist) { bestDist = dist; best = c; }
        }
        return best;
    }
    // ===== /helpers =====

    // Pointer-—Å–æ–±—ã—Ç–∏—è (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ –¥–ª—è –º—ã—à–∏/—Ç–∞—á–∞/–ø–µ—Ä–∞)
    track.addEventListener('pointerdown', (e) => {
        isPointerDown = true;
        isPointerInteracting = true;
        moved = false;
        startX = e.clientX;
        startY = e.clientY;
        startScroll = track.scrollLeft;
        track.setPointerCapture?.(e.pointerId);
    });

    track.addEventListener('pointermove', (e) => {
        if (!isPointerDown) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        if (!moved && Math.hypot(dx, dy) > 8) moved = true; // —á—É—Ç—å –±–æ–ª—å—à–µ –ø–æ—Ä–æ–≥ ¬´–¥—Ä–æ–∂–∞–Ω–∏—è¬ª
        track.scrollLeft = startScroll - dx;
    });

    function endPointer(e) {
        if (!isPointerDown) return;
        isPointerDown = false;

        requestAnimationFrame(() => {
            isPointerInteracting = false;
        });

        if (moved) {
            // –ø–æ—Å–ª–µ —Å–≤–∞–π–ø–∞ ‚Äî —Å–Ω—ç–ø –∫ –±–ª–∏–∂–∞–π—à–µ–π
            requestAnimationFrame(() => {
                const c = nearestCard();
                if (c) highlight(c, { scroll: true });
            });
        } else {
            // —ç—Ç–æ ¬´—Ç–∞–ø¬ª: –≤–æ–∑—å–º—ë–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ–¥ –ø–∞–ª—å—Ü–µ–º/–º—ã—à—å—é
            const el = document.elementFromPoint(e.clientX, e.clientY);
            const card = el?.closest?.('.carousel-2d-item');
            if (card && track.contains(card)) {
                highlight(card, { scroll: true });
            }
        }
    }

    track.addEventListener('pointerup', endPointer);
    track.addEventListener('pointercancel', endPointer);
    track.addEventListener('pointerleave', endPointer);

    // ADD THIS: scroll event listener for manual scroll selection
    track.addEventListener('scroll', () => {
        if (isPointerInteracting) return; // Don't update during pointer interaction

        const card = nearestCard();
        if (card && !card.classList.contains('active')) {
            requestAnimationFrame(() => {
                highlight(card, { scroll: false }); // Select without scrolling to prevent infinite loop
            });
        }
    });

    // –î–æ–ø. —Ñ–æ–ª–±—ç–∫: —è–≤–Ω—ã–µ –∫–ª–∏–∫–∏ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ pointer —Å–æ–±—ã—Ç–∏—è –≥–¥–µ-—Ç–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è)
    cards.forEach(c => {
        c.addEventListener('click', (e) => {
            // –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ –±—ã–ª —Å–≤–∞–π–ø ‚Äî –Ω–µ —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ –∫–ª–∏–∫–æ–º
            if (moved) return;
            highlight(c, { scroll: true });
        });
    });

    // –ü—É–±–ª–∏—á–Ω—ã–π API (–µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è)
    window.getSelectedStyle = function () { return selectedStyle; };
    window.setCarouselStyle = function (style) {
        const target = String(style || '').toLowerCase();
        const card = cards.find(c => (c.dataset.style || '').toLowerCase() === target);
        if (card) highlight(card, { scroll: true });
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    updateGutters();
    highlight(cards[0], { scroll: false });

    window.addEventListener('resize', () => {
        updateGutters();
        const active = track.querySelector('.carousel-2d-item.active');
        if (active) centerCard(active, true);
    });
})();

// üîÑ Action Functions
function newGeneration() {
    showGeneration();
    // Clear form
    //  document.getElementById('promptInput').value = '';
    //  document.getElementById('charCounter').textContent = '0';
}

function cancelGeneration() {
    if (appState.currentGeneration) {
        appState.currentGeneration.status = 'cancelled';
        appState.currentGeneration.error = 'Cancelled by user';
        appState.saveHistory();
    }

    appState.isGenerating = false;
    stopTimer();
    showGeneration();
    triggerHapticFeedback('medium');
}

/* –£–î–ê–õ–ï–ù–ê: –°–¢–ê–†–ê–Ø –§–£–ù–ö–¶–ò–Ø downloadImage - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –∏–∑ utils.js */

// üì± –ù–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è/—à–∞—Ä–∏–Ω–≥–∞ —Å –Ω–æ–≤—ã–º API
async function downloadImage() {
    if (!appState.currentGeneration?.result) return;

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ utils.js
    const result = await downloadOrShareImage(appState.currentGeneration.result, {
        filename: `ai-generated-${appState.currentGeneration.id}.png`
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω
    if (result.success && result.method !== 'failed') {
        // –ö–Ω–æ–ø–∫–∞ —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –Ω–æ –æ–±–Ω–æ–≤–∏–º —Å—Ç–∞—Ç—É—Å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        console.log('‚úÖ Download/share completed successfully with method:', result.method);
    }

    return result;
}
/*function downloadImage() {
    if (!appState.currentGeneration?.result) return;

    const link = document.createElement('a');
    link.href = appState.currentGeneration.result;
    link.download = `ai-generated-${appState.currentGeneration.id}.png`;
    link.click();

    showToast('info', appState.translate('download_started'));
    triggerHaptic('light');
}
*/

async function shareImage() {
    const gen = appState.currentGeneration;
    if (!gen?.result) return;

    const imageUrl = gen.result;
    const prompt = (gen.prompt || 'pixPLace Image').trim();
    const botUrl = CONFIG.TELEGRAM_BOT_URL || 'https://t.me/your_bot';
    const hashtags = CONFIG.SHARE_DEFAULT_HASHTAGS || '#pixPLace';

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ + —Ç–µ–∫—Å—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
    const title = prompt.length > 100 ? (prompt.slice(0, 97) + '...') : prompt;
    const postText = `${prompt}\n\nCreated with pixPLace ‚ú®\nTry it: ${botUrl}\n${hashtags}`;

    // –§—É–Ω–∫—Ü–∏—è –Ω–∞ —Å–ª—É—á–∞–π —Ñ–æ–ª–±—ç–∫–∞ ‚Äî –æ—Ç–∫—Ä—ã—Ç—å Pinterest composer –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
    const openPinterestFallback = async () => {
        try {
            // –û—Ç–∫—Ä–æ–µ–º Pinterest Pin Builder c –º–µ–¥–∏–∞ –∏ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –±–æ—Ç–∞
            const pinUrl = `https://www.pinterest.com/pin-builder/?` +
                `media=${encodeURIComponent(imageUrl)}` +
                `&url=${encodeURIComponent(botUrl)}` +
                `&description=${encodeURIComponent(postText)}`;
            window.open(pinUrl, '_blank', 'noopener,noreferrer');

            // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å–∫–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
            try {
                await navigator.clipboard.writeText(postText);
                showToast('info', appState.translate('copied_to_clipboard'));
            } catch { }
            triggerHaptic('light');
        } catch (e) {
            console.error('Pinterest fallback error:', e);
            // –ö—Ä–∞–π–Ω–∏–π —Ñ–æ–ª–±—ç–∫ ‚Äî –ø—Ä–æ—Å—Ç–æ –∫–æ–ø–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –±–æ—Ç–∞ + —Ç–µ–∫—Å—Ç
            try {
                await navigator.clipboard.writeText(`${postText}`);
                showToast('info', appState.translate('copied_to_clipboard'));
            } catch { }
        }
    };

    // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞—à–∞—Ä–∏—Ç—å —Ñ–∞–π–ª (Web Share API Level 2)
    try {
        // –°–∫–∞—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ blob (–º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å –∏–∑-–∑–∞ CORS ‚Äî –æ–±—Ä–∞–±–æ—Ç–∞–µ–º)
        const resp = await fetch(imageUrl, { mode: 'cors' });
        const blob = await resp.blob();

        const extByType = {
            'image/png': 'png',
            'image/jpeg': 'jpg',
            'image/webp': 'webp',
            'image/gif': 'gif'
        };
        const ext = extByType[blob.type] || 'png';

        // –ò–º—è —Ñ–∞–π–ª–∞ –∏–∑ –ø—Ä–æ–º–ø—Ç–∞
        const safeName = (prompt || 'pixplace-image')
            .toLowerCase()
            .replace(/[^\p{L}\p{N}\-_. ]/gu, '') // –æ—Å—Ç–∞–≤–∏—Ç—å –±—É–∫–≤—ã/—Ü–∏—Ñ—Ä—ã/–¥–µ—Ñ–∏—Å/–ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ/—Ç–æ—á–∫—É/–ø—Ä–æ–±–µ–ª
            .trim()
            .replace(/\s+/g, '-')
            .slice(0, 60) || 'pixplace-image';

        const file = new File([blob], `${safeName}.${ext}`, { type: blob.type || 'image/png' });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            const shareData = {
                title,
                text: postText,
                files: [file],
                // url –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å; –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —à–∞—Ä—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ files
                url: botUrl
            };

            await navigator.share(shareData);
            triggerHaptic('light');
            return;
        }

        // –ï—Å–ª–∏ canShare —Å —Ñ–∞–π–ª–∞–º–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ‚Äî Pinterest —Ñ–æ–ª–±—ç–∫
        await openPinterestFallback();
    } catch (err) {
        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å blob (—á–∞—Å—Ç–æ –∏–∑-–∑–∞ CORS) ‚Äî —É–π–¥—ë–º –≤ Pinterest —Ñ–æ–ª–±—ç–∫
        console.warn('Share with file failed (likely CORS). Fallback to Pinterest:', err);
        await openPinterestFallback();
    }
}



// üåç Global Functions
window.toggleLanguage = () => appState.toggleLanguage();
window.toggleTheme = () => appState.toggleTheme();
window.showHistory = showHistory;
window.showGeneration = showGeneration;
window.showProcessing = showProcessing;
//window.selectStyle = selectStyle;
window.selectStyle = (s) => window.setCarouselStyle(s);
window.generateImage = generateImage;
window.newGeneration = newGeneration;
window.cancelGeneration = cancelGeneration;
window.clearHistory = clearHistory;
window.downloadImage = downloadImage;
window.shareImage = shareImage;
window.showSubscriptionNotice = showSubscriptionNotice;

// üéµ Music Functions
/*let currentWidget = null;
let isPlaying = false;

function toggleMusicDropdown() {
    const dropdown = document.getElementById('musicDropdown');
    const isVisible = dropdown.style.display === 'block';

    if (isVisible) {
    dropdown.style.display = 'none';
    } else {
    dropdown.style.display = 'block';
    }

    console.log('üéµ Music dropdown toggled:', !isVisible);
}

function playPlaylist(type) {
    const playlists = {
    lofi: 'https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/330718027&color=%237a8fb5&auto_play=true&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false',
    ambient: 'https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/330718027&color=%237a8fb5&auto_play=true&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false',
    jazz: 'https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/330718027&color=%237a8fb5&auto_play=true&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false',
    relax: 'https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/330718027&color=%237a8fb5&auto_play=true&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false'
    };

    const iframe = document.getElementById('musicPlayer');
    iframe.src = playlists[type];

    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—ã
    const controls = document.getElementById('musicControls');
    if (controls) {
    controls.style.display = 'flex';
    }

    // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
    const playBtn = document.getElementById('playPauseBtn');
    if (playBtn) {
    playBtn.textContent = '‚ñ∂ Play';
    playBtn.onclick = function () {
    startMusicPlayback(type);
    };
    }

    console.log(`üéµ Loading ${type} playlist`);
}

function startMusicPlayback(type) {
    const playlists = {
    lofi: 'https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/330718027&color=%237a8fb5&auto_play=true&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false',
    ambient: 'https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/330718027&color=%237a8fb5&auto_play=true&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false',
    jazz: 'https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/330718027&color=%237a8fb5&auto_play=true&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false',
    relax: 'https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/330718027&color=%237a8fb5&auto_play=true&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false'
    };

    const iframe = document.getElementById('musicPlayer');
    iframe.src = playlists[type];

    const playBtn = document.getElementById('playPauseBtn');
    if (playBtn) {
    playBtn.textContent = '‚è∏';
    playBtn.onclick = togglePlayPause;
    }

    isPlaying = true;
    console.log(`üéµ Started ${type} playlist`);
}

function togglePlayPause() {
    const playBtn = document.getElementById('playPauseBtn');
    if (isPlaying) {
    playBtn.textContent = '‚ñ∂';
    isPlaying = false;
    } else {
    playBtn.textContent = '‚è∏';
    isPlaying = true;
    }
}

function setVolume(value) {
    console.log(`üîä Volume set to ${value}%`);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.addEventListener('click', function (event) {
    const musicWidget = document.querySelector('.music-widget');
    const dropdown = document.getElementById('musicDropdown');

    if (musicWidget && dropdown && !musicWidget.contains(event.target)) {
    dropdown.style.display = 'none';
    }
});*/
// –£–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è loadTelegramSDK - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –≤ index.html

// üß™ Debug Functions
window.getAppState = () => appState;
window.setWebhookUrl = (url) => {
    CONFIG.WEBHOOK_URL = url;
    console.log('‚úÖ Webhook URL updated');
};



console.log('üéØ pixPLace App loaded!');
console.log('üîß Debug commands:');
console.log('- getAppState() - get current app state');
console.log('- setWebhookUrl("url") - set webhook URL');
console.log('‚ö†Ô∏è Don\'t forget to set your webhook URL!');
// –î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞:
window.closeLimitModal = () => {
    const modal = document.getElementById('limitModal');
    if (modal) {
        modal.classList.remove('show');
        showGeneration();
    }
};

// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–∑ –º–æ–¥—É–ª—è

// –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏


// üî• –ö–ê–†–£–°–ï–õ–¨ –ü–õ–ê–ù–û–í –í –õ–ò–ú–ò–¢ –ú–û–î–ê–õ
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—É—Å–µ–ª—å—é –ø–ª–∞–Ω–æ–≤
let planCarouselInterval = null;
let currentPlanSlide = 0;

function initPlansCarousel() {
    const carousel = document.querySelector('.plans-carousel');
    const indicators = document.querySelectorAll('.indicator');

    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é highlight –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –ø–ª–∞–Ω–æ–≤
    function highlight(card, options = {}) {
        if (!card) return;

        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–ª–∞–Ω–æ–≤
        document.querySelectorAll('.plan-card').forEach(c => {
            c.classList.remove('active');
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ
        if (card && typeof card.classList !== 'undefined') {
            card.classList.add('active');
        }

        console.log('–ö–∞—Ä—Ç–æ—á–∫–∞ –ø–ª–∞–Ω–∞ –≤—ã–¥–µ–ª–µ–Ω–∞:', card ? 'OK' : 'null');
    }

    if (!carousel || !indicators.length) {
        console.log('Plans carousel not found, skipping init');
        return;
    }

    const cards = document.querySelectorAll('.plan-card');
    const totalSlides = Math.ceil(cards.length / 3); // 3 –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ —Å–ª–∞–π–¥

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
    function updateIndicators(activeIndex) {
        indicators.forEach((indicator, index) => {
            indicator.classList.toggle('active', index === activeIndex);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∫ —Å–ª–∞–π–¥—É
    function scrollToSlide(slideIndex) {
        currentPlanSlide = slideIndex;
        const cardWidth = cards[0].offsetWidth;
        const gap = 16; // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –≤ px
        const scrollLeft = slideIndex * (cardWidth * 3 + gap * 2);
        carousel.scrollTo({
            left: scrollLeft,
            behavior: 'smooth'
        });
        updateIndicators(slideIndex);
    }

    // –£–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫—É –ø–æ–ª–Ω–æ—Å—Ç—å—é, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

    // –ö–ª–∏–∫ –ø–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º (–æ—Å—Ç–∞–ª—Å—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)
    indicators.forEach((indicator, index) => {
        let lastClickTime = 0;

        indicator.addEventListener('click', (e) => {
            e.preventDefault();
            const now = Date.now();
            if (now - lastClickTime < 800) return; // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–ø–∞–º –∫–ª–∏–∫–∏
            lastClickTime = now;

            scrollToSlide(index);
        });
    });

    // –°–≤–∞–π–ø—ã - —á–∏—Å—Ç–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫)
    let touchStartX = 0;
    let touchStartTime = 0;

    carousel.addEventListener('touchstart', (e) => {
        touchStartTime = Date.now();
        touchStartX = e.changedTouches[0].screenX;
    });

    carousel.addEventListener('touchend', (e) => {
        const touchDuration = Date.now() - touchStartTime;
        const touchEndX = e.changedTouches[0].screenX;
        const diff = touchStartX - touchEndX;

        // –ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–≤–∞–π–ø–∞
        if (Math.abs(diff) > 60 && touchDuration > 100) {
            if (diff > 0 && currentPlanSlide < totalSlides - 1) {
                scrollToSlide(currentPlanSlide + 1);
            } else if (diff < 0 && currentPlanSlide > 0) {
                scrollToSlide(currentPlanSlide - 1);
            }
        }
    });

    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø - –ü–†–û–°–¢–û –¶–ï–ù–¢–†–ò–†–£–ï–ú PRO –ö–ê–†–¢–£ (–∏–Ω–¥–µ–∫—Å 1)
    const centerCardIndex = 1; // –ü—Ä–æ = –∏–Ω–¥–µ–∫—Å 1 (—Å–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –ø–ª–∞–Ω)
    const centerCard = cards[centerCardIndex];

    if (centerCard) {
        setTimeout(() => {
            const containerWidth = carousel.offsetWidth;
            const cardWidth = centerCard.offsetWidth;
            const cardLeft = centerCard.offsetLeft;
            const scrollPosition = cardLeft - (containerWidth / 2) + (cardWidth / 2);
            carousel.scrollLeft = Math.max(0, scrollPosition);

            // –ü—Ä–æ—Å—Ç–æ–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π
            setTimeout(() => {
                centerCard.scrollIntoView({
                    behavior: 'instant',
                    block: 'nearest',
                    inline: 'center'
                });
            }, 100);
        }, 50);
    }

    highlight(cards[centerCardIndex], { scroll: false });
    updateIndicators(centerCardIndex);
    console.log('üî• Plans carousel initialized - centered on PRO plan, auto-scroll REMOVED');
}

// üéØ –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–õ–Ø –ö–ê–†–¢–û–ß–ï–ö –ü–õ–ê–ù–û–í
function initPlanCards() {
    const cards = document.querySelectorAll('.plan-card');

    cards.forEach(card => {
        card.addEventListener('click', () => {
            const planType = card.className.includes('lite') ? 'lite' :
                card.className.includes('pro') ? 'pro' : 'studio';

            // –ê–Ω–∏–º–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞
            cards.forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');

            card.style.animation = 'pulse 0.6s ease-out';
            setTimeout(() => {
                card.style.animation = '';
            }, 600);

            console.log('Selected plan:', planType);
        });

        // –≠—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        card.addEventListener('mouseenter', () => {
            card.style.transform = 'translateY(-12px) scale(1.03)';
        });

        card.addEventListener('mouseleave', () => {
            if (!card.classList.contains('selected')) {
                card.style.transform = '';
            }
        });
    });
}

// üé® –≠–§–§–ï–ö–¢–´ –°–¢–ï–ö–õ–ê
function initGlassmorphismEffects() {
    const cards = document.querySelectorAll('.plan-card');

    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.2}s`;
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';

        setTimeout(() => {
            card.style.transition = 'all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 200);
    });
}

// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–£–°–ï–õ–ò –ü–†–ò –ü–û–ö–ê–ó–ï –ú–û–î–ê–õ–ê
document.addEventListener('DOMContentLoaded', function () {
    // –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ –ø–æ—è–≤–ª–µ–Ω–∏–µ–º –º–æ–¥–∞–ª–∞ –ª–∏–º–∏—Ç–∞
    const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const modal = document.getElementById('limitModal');
                if (modal && modal.classList.contains('show')) {
                    // –ú–æ–¥–∞–ª –ø–æ—è–≤–∏–ª—Å—è - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—É—Å–µ–ª—å
                    setTimeout(() => {
                        initPlansCarousel();
                        initPlanCards();
                        initGlassmorphismEffects();
                    }, 100);
                }
            }
        });
    });

    const modal = document.getElementById('limitModal');
    if (modal) {
        observer.observe(modal, {
            attributes: true,
            attributeFilter: ['class']
        });
    }
});

// üé® –§—É–Ω–∫—Ü–∏—è –º–æ—Ä–≥–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∞–Ω–∏–º–∞—Ü–∏—é need-image-pulse)
// üî• –£–î–ê–õ–ï–ù–ê: –§—É–Ω–∫—Ü–∏—è startUploadButtonBlink –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞ - –∫–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
// –ï—Å–ª–∏ –≥–¥–µ-—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è - –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∏–ª–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –ª–æ–≥–∏–∫—É
function startUploadButtonBlink() {
    console.log('‚ö†Ô∏è startUploadButtonBlink –≤—ã–∑–≤–∞–Ω–∞, –Ω–æ –º–æ—Ä–≥–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω–æ - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ UI');
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –±–µ–∑ –º–æ—Ä–≥–∞–Ω–∏—è
    updateImageUploadVisibility();
}


// üéØ –§—É–Ω–∫—Ü–∏–∏ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ –º–æ–¥—É–ª—è user-account.js
// üéØ AI Coach –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ ai-coach.js –º–æ–¥—É–ª—å

// üî• –§–£–ù–ö–¶–ò–ò –û–ë–†–ê–ë–û–¢–ö–ò –û–®–ò–ë–û–ö –û–ë–†–£–ë–û–í–ê–ù–´ –í SCREEN-MANAGER (–ò–ú–ü–û–†–¢ –í–´–®–ï)
