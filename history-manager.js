// üéØ –ú–æ–¥—É–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–π pixPLace
// –ò–º–ø–æ—Ä—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
// –ò–º–ø–æ—Ä—Ç —É–±—Ä–∞–Ω–æ - globalHistoryLoader –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ window

class HistoryManagement {
    constructor() {
        // –°–≤—è–∑—å —Å globalHistoryLoader —á–µ—Ä–µ–∑ window
        this.globalHistoryLoader = null; // –ë—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ
        console.log('üìã HistoryManagement initialized');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    async updateHistoryItemWithImage(generationId, imageUrl) {
        const loadingItem = document.getElementById(`loading-${generationId}`);
        if (!loadingItem) {
            console.warn(`‚ùå Loading item for generation ${generationId} not found`);
            return;
        }

        // ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ú–ï–ù–Ø–ï–ú ID –≠–õ–ï–ú–ï–ù–¢–ê –î–õ–Ø –ü–†–ï–î–û–¢–í–†–ê–©–ï–ù–ò–Ø –î–£–ë–õ–ò–ö–ê–¢–û–í
        loadingItem.id = `history-${generationId}`;
        console.log(`üîß Changed loading item ID from loading-${generationId} to history-${generationId}`);
        console.log('üéØ == GEN COMPLETE UPDATE == replacing loading cover with real image');

        // üé® –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ó–ê–ú–ï–ù–Ø–ï–ú –í–°–Æ –û–ë–õ–û–ñ–ö–£ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        console.log('üîÑ Replacing loading cover with real image for:', generationId);

        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å history-loading (—Ç–µ–ø–µ—Ä—å —ç—Ç–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è)
        loadingItem.classList.remove('history-loading');

        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const realImage = document.createElement('img');
        realImage.className = 'lazy-loading loaded'; // —Å—Ä–∞–∑—É –æ—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π
        realImage.src = imageUrl;
        realImage.alt = 'Generated image';
        realImage.loading = 'lazy';
        realImage.decoding = 'async';

        // ‚ö° –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê: —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        // –£–¥–∞–ª—è–µ–º –∫—Ä–∞—Å–∏–≤—É—é –æ–±–ª–æ–∂–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        const loadingWrapper = loadingItem.querySelector('.loading-wrapper');
        if (loadingWrapper) {
            loadingWrapper.remove();
            console.log('üóëÔ∏è Removed loading wrapper');
        }

        // –í—Å—Ç–∞–≤–ª—è–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ü–ï–†–í–´–ú —ç–ª–µ–º–µ–Ω—Ç–æ–º
        loadingItem.insertBefore(realImage, loadingItem.firstChild);
        console.log('‚úÖ Added real image to loading item');

        // ‚ú® –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è
        realImage.style.opacity = '0';
        requestAnimationFrame(() => {
            realImage.style.opacity = '1';
            realImage.style.transition = 'opacity 0.4s ease-out';
            console.log('‚ú® Applied fade-in effect to real image');
        });

        // üêõ –ù–ï–ú–ù–û–ì–û –°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–ò: double-check —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
        realImage.onload = () => {
            realImage.classList.add('loaded');
            console.log('‚úÖ Real image successfully loaded in history:', generationId);
        };

        realImage.onerror = () => {
            // console.warn('‚ö†Ô∏è Real image failed to load:', imageUrl); // –ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–ù–û - —É–±—Ä–∞–Ω —Å–ø–∞–º
            // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º placeholder
            realImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMvb3JnLzIwMDAvc3ZnIj4KPGRlZnM+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+LmV4cGlyZWQtdGV4dHtiYTpnZW5lcmFsIFNhbnMsQXJpYWwsSGVsdmV0aWNhLHNhbnMtc2VyaWY7Zm9udC1zaXplOiAxNHB4O2ZpbFw6ICM5OTk5OTk7fTwvc3R5bGU+CjwvZGVmcz4KPHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2Y0ZjRmNCIvPgo8dGV4dCB4PSI1MCUiIHk9IjUwJSIgZHk9Ii4zNWVtIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBjbGFzcz0iZXhwaXJlZC10ZXh0IiBzdHlsZT0iYXVjLWFncmlkLXJvd3M6IHNwYW4gMS8yOyB2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlOyBvcGFjaXR5OiAwLjg7Ij5FeHBpcmVkPC90ZXh0PiAKPC9zdmc+';
        };

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        const loadingCaption = loadingItem.querySelector('p');
        if (loadingCaption) {
            // –ù–∞–π–¥–µ–º –æ–±—ä–µ–∫—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ ID
            const generation = window.appState.generationHistory.find(g => g.id == generationId);
            const mode = generation ? generation.mode : 'unknown';
            const style = generation ? generation.style : 'realistic';

            loadingCaption.innerHTML = `
        <span class="complete-status">‚úÖ Complete</span><br>
        <small class="history-date">${new Date().toLocaleDateString()} | ${window.appState.translate('style_' + style)} | ${window.appState.translate('mode_' + mode)}</small>
    `;

            // –î–æ–±–∞–≤–ª—è–µ–º –º—è–≥–∫—É—é –∞–Ω–∏–º–∞—Ü–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
            loadingCaption.style.opacity = '0';
            requestAnimationFrame(() => {
                loadingCaption.style.opacity = '1';
                loadingCaption.style.transition = 'opacity 0.2s ease-in-out';
            });
        }

        // –£–±–∏—Ä–∞–µ–º loading –∫–ª–∞—Å—Å —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è –¥–ª—è smooth —ç—Ñ—Ñ–µ–∫—Ç–∞
        setTimeout(() => {
            loadingItem.classList.remove('history-loading');
        }, 300);

        // –î–æ–±–∞–≤–ª—è–µ–º onclick –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        loadingItem.onclick = () => viewHistoryItem(generationId);

        console.log('üñºÔ∏è Updated history item with generated image:', generationId, imageUrl);

        // üêõ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—å—é
        setTimeout(() => {
            const elementAfterTimeout = document.getElementById(`history-${generationId}`);
            if (elementAfterTimeout) {
                console.log('‚úÖ Preview element found in DOM:', generationId);
                if (window.globalHistoryLoader) {
                    window.globalHistoryLoader.forceLoadVisibleHistoryPreviews();
                    console.log('üîÑ Forced visibility check for loaded image');
                }
    } else {
        console.warn('‚ö†Ô∏è No items to display on page', page);
    }
        }, 500);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è placeholder'–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ (–≤—ã–Ω–µ—Å–µ–Ω–∞ –∏–∑ app_modern.js)
function createLoadingHistoryItem(generation) {
    console.log('üîß createLoadingHistoryItem called for generation:', generation.id);

    const historyList = document.getElementById('historyList');
    if (!historyList) {
        console.warn('‚ùå historyList element not found!');
        return null;
    }
    console.log('‚úÖ historyList found, proceeding with creation');

    // ‚ò†Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –î–£–ë–õ–ò–ö–ê–¢–û–í: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è —ç—Ç–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    const existingLoading = document.getElementById(`loading-${generation.id}`);
    if (existingLoading) {
        console.log(`üö´ Loading item for generation ${generation.id} already exists, returning existing`);
        return existingLoading; // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç
    }

    // –°–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç –Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏–∏
    const loadingItem = document.createElement('div');
    loadingItem.className = 'history-mini history-loading';
    loadingItem.id = `loading-${generation.id}`;
    // –î–æ–±–∞–≤–ª—è–µ–º onclick —Å—Ä–∞–∑—É
    loadingItem.onclick = () => console.log('Loading item clicked, but still processing...');

    // üé® –ö–†–ê–°–ò–í–ê–Ø –û–ë–õ–û–ñ–ö–ê –ò–°–ü–û–õ–¨–ó–£–Æ–©–ê–Ø CSS –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò–ó VARIABLES.CSS
    const loadingWrapper = document.createElement('div');
    loadingWrapper.className = 'loading-wrapper';

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    const body = document.body;
    const isDark = body.classList.contains('dark') || body.getAttribute('data-theme') === 'dark';
    const isLight = body.classList.contains('light') || body.getAttribute('data-theme') === 'light';

    let gradientVar;
    if (isDark) {
        gradientVar = 'var(--loading-cover-dark)';
    } else if (isLight) {
        gradientVar = 'var(--loading-cover-light)';
    } else {
        gradientVar = 'var(--loading-cover-auto)';
    }

    loadingWrapper.style.cssText = `
        position: relative;
        width: 100%;
        height: 100%;
        background: ${gradientVar};
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease; /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ —Ü–≤–µ—Ç–∞ */
    `;

    // —ç—Ñ—Ñ–µ–∫—Ç "–∑–≤–µ–∑–¥–Ω–æ–≥–æ –Ω–µ–±–∞"
    const starsPattern = document.createElement('div');
    starsPattern.style.cssText = `
        position: absolute;
        width: 100%;
        height: 100%;
        background:
            radial-gradient(circle at 20% 30%, rgba(255,255,255,0.1) 1px, transparent 1px),
            radial-gradient(circle at 70% 80%, rgba(255,255,255,0.1) 1px, transparent 1px),
            radial-gradient(circle at 50% 20%, rgba(255,255,255,0.15) 1px, transparent 1px),
            radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 1px, transparent 1px);
        background-size: 20px 20px;
        animation: twinkle 2s ease-in-out infinite alternate;
    `;

    // ‚ú® –õ–û–ü–ê–Æ–©–ò–ï–°–Ø –ó–í–Å–ó–î–û–ß–ö–ò (CSS –ê–ù–ò–ú–ê–¶–ò–Ø)
    const sparkle1 = document.createElement('div');
    sparkle1.style.cssText = `
        position: absolute;
        top: 15%;
        left: 25%;
        width: 4px;
        height: 4px;
        background: white;
        border-radius: 50%;
        animation: sparkle-appear 1.5s ease-in-out infinite;
        animation-delay: 0.2s;
    `;

    const sparkle2 = document.createElement('div');
    sparkle2.style.cssText = `
        position: absolute;
        top: 70%;
        right: 20%;
        width: 3px;
        height: 3px;
        background: rgba(255,255,255,0.8);
        border-radius: 50%;
        animation: sparkle-appear 1.5s ease-in-out infinite;
        animation-delay: 0.7s;
    `;

    const sparkle3 = document.createElement('div');
    sparkle3.style.cssText = `
        position: absolute;
        bottom: 20%;
        left: 15%;
        width: 5px;
        height: 5px;
        background: white;
        border-radius: 50%;
        animation: sparkle-appear 1.5s ease-in-out infinite;
        animation-delay: 1.1s;
    `;

    // ‚ú® Ï§ëÏïôÏóê ÏïÑÏù¥ÏΩò (–í–∑—Ä—ã–≤–∞—é—â–∞—è—Å—è –∑–≤–µ–∑–¥–∞)
    const sparkIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    sparkIcon.setAttribute('viewBox', '0 0 24 24');
    sparkIcon.setAttribute('fill', 'none');
    sparkIcon.setAttribute('stroke', 'white');
    sparkIcon.setAttribute('stroke-width', '2');
    sparkIcon.setAttribute('stroke-linecap', 'round');
    sparkIcon.setAttribute('stroke-linejoin', 'round');
    sparkIcon.style.cssText = `
        width: 32px;
        height: 32px;
        animation: pulse-glow 1.5s ease-in-out infinite alternate;
        filter: drop-shadow(0 0 8px rgba(255,255,255,0.3));
    `;

    // –ü—É—Ç—å –¥–ª—è –∑–≤–µ–∑–¥—ã (–í–∑—Ä—ã–≤–∞—é—â–∞—è—Å—è –∑–≤–µ–∑–¥–∞)
    const sparkPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    sparkPath.setAttribute('d', 'M12 3L14.09 8.26L20 7.27L15.82 11.14L18.18 17.02L12 14.77L5.82 17.02L8.18 11.14L4 7.27L9.91 8.26L12 3Z');
    sparkIcon.appendChild(sparkPath);

    // üî• –ö–ª—é—á–µ–≤—ã–µ CSS –∞–Ω–∏–º–∞—Ü–∏–∏ (—á–µ—Ä–µ–∑ line-height 0 –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏)
    const styleElement = document.createElement('style');
    styleElement.textContent = `
        @keyframes twinkle {
            0% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        @keyframes sparkle-appear {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }
        @keyframes pulse-glow {
            0% { transform: scale(1); }
            100% { transform: scale(1.2); }
        }
    `;

    // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –æ–±–ª–æ–∂–∫–∏
    loadingWrapper.appendChild(starsPattern);
    loadingWrapper.appendChild(sparkle1);
    loadingWrapper.appendChild(sparkle2);
    loadingWrapper.appendChild(sparkle3);
    loadingWrapper.appendChild(sparkIcon);
    loadingWrapper.appendChild(styleElement); // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏

    // –°–æ–∑–¥–∞—ë–º –ø–æ–¥–ø–∏—Å—å - –∫—Ä–∞—Å–Ω—É—é –∏ —Å—Ç–∏–ª—å–Ω—É—é
    const loadingCaption = document.createElement('p');
    loadingCaption.classList.add('history-caption');
    loadingCaption.innerHTML = `<span style="color: #ffffff; font-weight: 600; font-size: 12px; letter-spacing: 0.5px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">Generating...</span>`;

    // –°–æ–±–∏—Ä–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
    loadingItem.appendChild(loadingWrapper);
    loadingItem.appendChild(loadingCaption);

    console.log('‚úÖ Created beautiful loading item with animated cover');

    // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
    const firstHistoryItem = historyList.querySelector('.history-mini');
    if (firstHistoryItem) {
        historyList.insertBefore(loadingItem, firstHistoryItem);
        console.log('‚úÖ Inserted before first history item');
    } else {
        historyList.appendChild(loadingItem);
        console.log('‚úÖ Appended as first child');
    }

    // üîç –ü–†–û–í–ï–†–ö–ê: –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω
    const addedItem = document.getElementById(`loading-${generation.id}`);
    if (addedItem) {
        console.log('‚úÖ Loading item successfully added to DOM:', addedItem.id);
        console.log('üìä Current history list children count:', historyList.children.length);
        console.log('üìã History list children:', Array.from(historyList.children).map(c => c.id || c.className));
    } else {
        console.error('‚ùå Loading item NOT found in DOM after adding!');
    }

    return loadingItem;
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏ (–≤—ã–Ω–µ—Å–µ–Ω–∞ –∏–∑ app_modern.js)
function viewHistoryItem(id) {
    const item = window.appState.generationHistory.find(h => h.id == id);
    if (item && item.result) {
        window.appState.currentGeneration = item;
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ screen-manager.js
        import('./screen-manager.js').then(module => {
            module.displayFullResult({ image_url: item.result });
        });
    }
}

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
const historyManagement = new HistoryManagement();

export {
    HistoryManagement,
    historyManagement,
    createLoadingHistoryItem,
    viewHistoryItem
};

// üöÄ –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ app_modern.js –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∏—Å—Ç–æ—Ä–∏–∏

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
function updateHistoryDisplay(page = 0) {
    const historyList = document.getElementById('historyList');
    if (!historyList) {
        console.warn('‚ùå historyList element not found!');
        return;
    }

    // üî• –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    const generationHistory = window.appState?.generationHistory || [];
    console.log('üè• HISTORY DIAGNOSTIC:');
    console.log(`üìä Total items in history: ${generationHistory.length}`);
    console.log('üìã First 3 items:', generationHistory.slice(0, 3));

    // üßπ –û–ß–ò–°–¢–ö–ê –ò–°–¢–û–†–ò–ò: –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å result === 'undefined' –ò–õ–ò –≤–æ–æ–±—â–µ –±–µ–∑ result
    const filteredHistory = generationHistory.filter(item => {
        const isValid = item &&
                       item.result !== undefined &&
                       item.result !== null &&
                       item.result !== 'undefined' &&
                       item.result !== '' &&
                       typeof item.result === 'string' &&
                       item.result.trim() !== '';

        if (!isValid) {
            console.log(`üóëÔ∏è Filtering out corrupted/invalid history item:`, {
                id: item.id,
                result: item.result,
                type: typeof item.result,
                status: item.status,
                timestamp: item.timestamp
            });
        }

        return isValid;
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    if (filteredHistory.length !== generationHistory.length) {
        console.log(`üßπ Cleaned history: ${generationHistory.length} ‚Üí ${filteredHistory.length} items`);
        window.appState.generationHistory = filteredHistory;
        window.appState.saveHistory();

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ UI
        setTimeout(() => {
            const historyToggleBtn = document.getElementById('historyToggleBtn');
            if (historyToggleBtn) {
                const count = filteredHistory.length;
                const baseText = 'Generation History';
                historyToggleBtn.textContent = count > 0 ? `${baseText} (${count})` : baseText;
            }
        }, 100);
    }

    const validItems = generationHistory.filter(item => {
        const isValid = item.result &&
                       typeof item.result === 'string' &&
                       item.result.trim() !== '' &&
                       item.result !== 'undefined';

        if (!isValid) {
            console.log(`‚ùå Filtered out invalid item:`, {
                id: item.id,
                result: item.result,
                type: typeof item.result,
                trimmed: item.result?.trim?.(),
                isUndefined: item.result === 'undefined'
            });
        }

        return isValid;
    });

    console.log(`‚úÖ Valid items after filtering: ${validItems.length}/${generationHistory.length}`);

    if (validItems.length === 0) {
        historyList.innerHTML = `
    <div class="empty-history">
    <div class="empty-icon">üìã</div>
    <h3 data-i18n="empty_history_title">${window.appState?.translate?.('empty_history_title') || 'No history yet'}</h3>
    <p data-i18n="empty_history_subtitle">${window.appState?.translate?.('empty_history_subtitle') || 'Generate your first image!'}</p>
    </div>
    `;
        console.log('üìù Displaying empty history message');
        return;
    }

    // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - –æ—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
    if (page === 0) {
        historyList.innerHTML = '';
        console.log('üìã Cleared history list for fresh display');
    }

    // üî• –ù–û–í–û–ï: –ò–∑–º–µ–Ω–µ–Ω –ª–∏–º–∏—Ç –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ç–æ–ª—å–∫–æ 6 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞—Ö–æ–¥–µ
    const itemsPerPage = page === 0 ? 6 : 15; // –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –¢–û–õ–¨–ö–û 6 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –ø–æ—Ç–æ–º 15

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const pageItems = page === 0
        ? validItems.slice(0, 6)  // –ø–µ—Ä–≤—ã–µ 6 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        : validItems.slice(page * itemsPerPage, (page + 1) * itemsPerPage);

    console.log(`üìÑ Page ${page}: loading ${pageItems.length} items from ${validItems.length} total`);

    if (pageItems.length > 0) {
        // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        pageItems.forEach((item, index) => {
            console.log(`üé® Creating element ${index + 1}/${pageItems.length} for item ID ${item.id}`);

            const element = document.createElement('div');
            element.className = 'history-mini';
            element.id = `history-${item.id}`;
            element.onclick = () => {
                console.log(`üñ±Ô∏è Clicked on history item ${item.id}, calling viewHistoryItem`);
                viewHistoryItem(item.id);
            };

            const imageUrl = item.result || '';
            console.log(`üñºÔ∏è Item ${item.id} image URL length: ${imageUrl.length}, preview: ${imageUrl.substring(0, 50)}...`);

            // üîß –ó–ê–©–ò–¢–ê –û–¢ –°–í–ò–ì-–ü–ï–†–ï–°–¢–ê–í–û–í–ö–ò: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞—Ä–∞–Ω–µ–µ
            const isSvgPlaceholder = imageUrl.startsWith('data:image/svg+xml;base64,') ||
                                   imageUrl.includes('Expired') ||
                                   imageUrl === 'undefined';

            const isBrokenImage = !imageUrl || imageUrl.trim() === '' || isSvgPlaceholder;

            element.innerHTML = isBrokenImage ? `
                <div class="broken-image-placeholder" style="
                    width: 100%;
                    height: 120px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    background: var(--bg-secondary, #f8f9fa);
                    border: 1px solid var(--border-primary, #dee2e6);
                    border-radius: 8px;
                    color: var(--text-secondary, #6c757d);
                    font-size: 12px;
                    text-align: center;
                    padding: 8px;
                ">
                    <div style="font-size: 24px; margin-bottom: 4px;">üì∑</div>
                    <div>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</div>
                    <div style="font-size: 10px; margin-top: 2px;">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é</div>
                </div>
                <p class="history-caption">${new Date(item.timestamp).toLocaleDateString()} | ${window.appState?.translate?.('style_' + item.style) || item.style} | ${window.appState?.translate?.('mode_' + item.mode) || item.mode}</p>
            ` : `
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMvb3JnLzIwMDAvc3ZnIj4KPGRlZnM+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+LmV4cGlyZWQtdGV4dHtiYTpnZW5lcmFsIFNhbnMsQXJpYWwsSGVsdmV0aWNhLHNhbnMtc2VyaWY7Zm9udC1zaXplOiAxNHB4O2ZpbGw6ICM5OTk5OTk7fTwvc3R5bGU+CjwvZGVmcz4KPHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2Y0ZjRmNCIvPgo8dGV4dCB4PSI1MCUiIHk9IjUwJSIgZHk9Ii4zNWVtIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBjbGFzcz0iZXhwaXJlZC10ZXh0IiBzdHlsZT0iYXVjLWFncmlkLXJvd3M6IHNwYW4gMS8yOyB2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlOyBvcGFjaXR5OiAwLjg7Ij5FeHBpcmVkPC90ZXh0PiAKPC9zdmc+"
                     data-src="${imageUrl}"
                     alt="Generated"
                     class="lazy-loading"
                     loading="lazy"
                     decoding="async"
                     />
                <p class="history-caption">${new Date(item.timestamp).toLocaleDateString()} | ${window.appState?.translate?.('style_' + item.style) || item.style} | ${window.appState?.translate?.('mode_' + item.mode) || item.mode}</p>
            `;

            historyList.appendChild(element);
            console.log(`‚ûï Added element for item ${item.id} to DOM`);

            // üöÄ OPTIMIZED LAZY LOADING WITHOUT DEVICE STRESS (–¢–û–õ–¨–ö–û –¥–ª—è —Ä–∞–±–æ—á–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
            const img = element.querySelector('img[data-src]');
            if (!img) {
                console.warn(`‚ùå No img element found for item ${item.id}`);
                return;
            }

            // ‚úã –ü–†–û–¢–ï–ö–¶–ò–Ø –û–¢ –°–ü–ê–ú–ê: –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–æ–æ–±—â–µ!
            if (isBrokenImage) {
                console.log(`üö´ Skipping lazy loading setup for broken image ${item.id}`);
                return; // <-- –ü–û–õ–ù–´–ô –≤—ã—Ö–æ–¥ –∏–∑ –∫—Ä–∏—Ç–µ—Ä–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏, –Ω–∏–∫–∞–∫–∏—Ö lazy loading!
            }

            console.log(`üì± LAZY SETUP for item ${item.id}`);

            // üî• –£–ú–ù–ê–Ø –õ–û–ì–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò:
            // –î–ª—è –ø–µ—Ä–≤—ã—Ö 6 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ - EAGER loading (—á—Ç–æ–±—ã —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑–∞—Ç—å —Å–∞–º—ã–µ —Å–≤–µ–∂–∏–µ)
            // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - LAZY loading –ø–æ –≤–∏–¥–∏–º–æ—Å—Ç–∏
            const isFirstPage = page === 0;
            const isFirstElements = index < 6; // –ü–µ—Ä–≤—ã–µ 6 —Å–∞–º—ã—Ö —Å–≤–µ–∂–∏—Ö

            if (isFirstPage && isFirstElements) {
                // ‚ö° EAGER LOADING –¥–ª—è —Å–∞–º—ã—Ö —Å–≤–µ–∂–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                console.log(`‚ö° EAGER loading fresh image ${index + 1}/6 for ${item.id}`);
                img.src = img.dataset.src;
                delete img.dataset.src;
                img.classList.add('loaded');
                img.style.opacity = '1';
            } else {
                // ü¶• LAZY LOADING –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                console.log(`ü¶• LAZY setup for item ${item.id}`);
                if (window.globalHistoryLoader && window.globalHistoryLoader.observe) {
                    window.globalHistoryLoader.observe(img);
                } else {
                    // Fallback - –∑–∞–≥—Ä—É–∂–∞–µ–º –µ—Å–ª–∏ IntersectionObserver –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                    console.log(`‚ö†Ô∏è IntersectionObserver not available, fallback to direct loading for ${item.id}`);
                    img.src = img.dataset.src;
                    delete img.dataset.src;
                    img.classList.add('loaded');
                }
            }

            // ‚úÖ –£–±—Ä–∞–Ω—ã –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ - –Ω–µ—Ç —Å–ø–∞–º–∞ –≤ –∫–æ–Ω—Å–æ–ª—å
        });

        console.log(`üèÅ History display updated: showing ${pageItems.length} items from page ${page}, total valid: ${validItems.length}`);
        console.log('üìä History list children count:', historyList.children.length);
    } else {
        console.warn('‚ö†Ô∏è No items to display on page', page);
    }

    // üî• –ü–†–û–°–¢–ê–Ø –õ–û–ì–ò–ö–ê: –ö–Ω–æ–ø–∫–∞ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë" —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –ü–û–°–õ–ï —Å–ø–∏—Å–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ (> 6)
    if (validItems.length > 6) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å
        const existingBtn = document.getElementById('loadMoreHistoryBtn');
        if (existingBtn) {
            existingBtn.remove();
        }

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–Ω–æ–ø–∫—É
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.id = 'loadMoreHistoryBtn';
        loadMoreBtn.className = 'load-more-btn';
        loadMoreBtn.innerHTML = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë...';
        loadMoreBtn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('üéØ Load more button clicked');
            loadNextHistoryPage();
        };
        // –û—á–∏—â–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
        loadMoreBtn.onmousedown = null;
        loadMoreBtn.onmouseup = null;
        loadMoreBtn.onpointerdown = null;
        loadMoreBtn.onpointerup = null;


    
        // üî• –î–û–ë–ê–í–õ–Ø–ï–ú –ö–ù–û–ü–ö–£ –í–ù–£–¢–†–¨ –°–ü–ò–°–ö–ê –ò–°–¢–û–†–ò–ò –ö–ê–ö –ü–û–°–õ–ï–î–ù–ò–ô –≠–õ–ï–ú–ï–ù–¢
        loadMoreBtn.className = 'load-more-btn history-mini';
        loadMoreBtn.textContent = `üìö –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë...`;
        loadMoreBtn.style.cssText = `
            width: 100% !important;
            height: 120px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 16px !important;
            font-weight: bold !important;
            background: transparent !important; /* –£–±–∏—Ä–∞–µ–º —è—Ä–∫–∏–π —Ñ–æ–Ω–∞ */
            border: 2px dashed var(--border-primary, #dee2e6) !important; /* –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç—É—Ä */
            border-radius: 8px !important;
            color: var(--text-secondary, #6c757d) !important; /* –°–µ—Ä—ã–π —Ç–µ—Å—Ç –≤–º–µ—Å—Ç–æ —è—Ä–∫–æ–≥–æ */
            cursor: pointer !important;
            margin: 8px 0 !important;
            visibility: visible !important;
            opacity: 1 !important;
        `;
        historyList.appendChild(loadMoreBtn);
        console.log('‚úÖ Load more button added after history list');

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏
        loadMoreBtn.style.cssText = `
            display: block !important;
            margin: 20px auto !important;
            padding: 12px 24px !important;
            background: #007bff !important;
            color: white !important;
            border: none !important;
            border-radius: 25px !important;
            font-size: 16px !important;
            cursor: pointer !important;
            visibility: visible !important;
            opacity: 1 !important;
        `;
    } else if (validItems.length <= 6) {
        // –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ 6 –∏–ª–∏ –º–µ–Ω—å—à–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const existingBtn = document.getElementById('loadMoreHistoryBtn');
        if (existingBtn) {
            existingBtn.remove();
            console.log('üóëÔ∏è Load more button removed - 6 or fewer items');
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏—Å—Ç–æ—Ä–∏–∏
function loadNextHistoryPage() {
    const validItems = window.appState.generationHistory.filter(item =>
        item.result &&
        typeof item.result === 'string' &&
        item.result.trim() !== '' &&
        item.result !== 'undefined'
    );

    const itemsPerPage = 15; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    const totalPages = Math.ceil(validItems.length / itemsPerPage);
    const nextPage = Math.floor(validItems.length / itemsPerPage); // –í—ã—á–∏—Å–ª—è–µ–º —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

    if (nextPage >= totalPages) {
        console.log('üìÑ No more pages to load');
        return;
    }

    console.log(`üìÑ Loading next history page: ${nextPage}`);
    updateHistoryDisplay(nextPage);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
    setTimeout(() => {
        const btn = document.getElementById('loadMoreHistoryBtn');
        if (btn) {
            if (nextPage + 1 >= totalPages) {
                btn.textContent = '–í—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ! üéâ';
                btn.disabled = true;
                btn.style.opacity = '0.5';
            } else {
                btn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë...';
                btn.disabled = false;
            }
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–µ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 300);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏ –±–µ–∑ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏
function showAllHistory() {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    const validItems = window.appState.generationHistory.filter(item =>
        item.result &&
        typeof item.result === 'string' &&
        item.result.trim() !== '' &&
        item.result !== 'undefined'
    );

    historyList.innerHTML = validItems.map(item => {
        const element = document.createElement('div');
        element.className = 'history-mini';
        element.id = `history-${item.id}`;
        element.onclick = () => viewHistoryItem(item.id);

        element.innerHTML = `
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMvb3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzc0MTUxIj48L3JlY3Q+PC9zdmc+"
                 data-src="${item.result || ''}"
                 alt="Generated"
                 class="lazy-loading"
                 loading="lazy"
                 decoding="async"
                 ${item.result ? '' : 'style="opacity: 0.7;"'}
                 />
            <p class="history-caption">${new Date(item.timestamp).toLocaleDateString()} | ${window.appState.translate('style_' + item.style)} | ${window.appState.translate('mode_' + item.mode)}</p>
        `;

        return element.outerHTML;
    }).join('');

    // –ü–æ–¥–∫–ª—é—á–∞–µ–º Observer –∫–æ –≤—Å–µ–º –Ω–æ–≤—ã–º –∫–∞—Ä—Ç–∏–Ω–∫–∞–º
    const newImages = historyList.querySelectorAll('img[data-src]');
    newImages.forEach(img => {
        if (window.globalHistoryLoader) {
            window.globalHistoryLoader.observe(img);
        }
    });

    console.log('üìÑ All history loaded without virtualization');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
function clearHistory() {
    if (confirm('Clear all generation history?')) {
        window.appState.generationHistory = [];
        window.appState.saveHistory();
        updateHistoryDisplay();
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é triggerHaptic –∏–∑ app_modern.js
        if (window.triggerHaptic) {
            window.triggerHaptic('medium');
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
function toggleHistoryList() {
    const list = document.getElementById('historyList');
    const btn = document.getElementById('historyToggleBtn');
    if (list.classList.contains('hidden')) {
        list.classList.remove('hidden');
        btn.classList.add('active');
        updateHistoryDisplay();

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏
        setTimeout(() => {
            const historyList = document.getElementById('historyList');
            if (historyList && historyList.lastElementChild) {
                historyList.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'end' });
                console.log('üñºÔ∏è Scrolled to bottom image in history');
            }
        }, 150);
    } else {
        list.classList.add('hidden');
        btn.classList.remove('active');
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–æ–¥ –≤ HistoryManagement –∫–ª–∞—Å—Å –¥–ª—è eager loading
HistoryManagement.prototype.loadEagerForElement = function(element) {
    if (!element) return;

    const img = element.querySelector('img[data-src]');
    if (!img || !img.dataset.src) return;

    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ IntersectionObserver
    img.src = img.dataset.src;
    delete img.dataset.src;

    console.log(`‚ö° Eager loaded image: ${img.src}`);
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º (–¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞)
function updateHistoryItemWithImage(generationId, imageUrl) {
    return historyManagement.updateHistoryItemWithImage(generationId, imageUrl);
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
export {
    updateHistoryDisplay,
    loadNextHistoryPage,
    showAllHistory,
    clearHistory,
    toggleHistoryList,
    updateHistoryItemWithImage
};

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
window.updateHistoryDisplay = updateHistoryDisplay;
window.loadNextHistoryPage = loadNextHistoryPage;
window.showAllHistory = showAllHistory;
window.clearHistory = clearHistory;
window.toggleHistoryList = toggleHistoryList;
window.updateHistoryItemWithImage = (generationId, imageUrl) => historyManagement.updateHistoryItemWithImage(generationId, imageUrl);
window.createLoadingHistoryItem = createLoadingHistoryItem;
window.viewHistoryItem = viewHistoryItem;

console.log('üéØ History Management module loaded successfully');
