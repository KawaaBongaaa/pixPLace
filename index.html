<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Генератор Изображений</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Встроенные стили для избежания проблем с загрузкой CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 16px;
            min-height: 100vh;
        }

        /* Заголовок */
        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 20px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Основной контент */
        .main-content {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        /* Секция ввода */
        .input-section {
            margin-bottom: 24px;
        }

        .input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #333);
        }

        #prompt {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--tg-theme-button-color, #007AFF);
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: border-color 0.3s ease;
        }

        #prompt:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Секция стилей */
        .style-section {
            margin-bottom: 24px;
        }

        .style-section label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .style-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .style-btn {
            padding: 12px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #333);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .style-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .style-btn.active {
            border-color: var(--tg-theme-button-color, #007AFF);
            background: var(--tg-theme-button-color, #007AFF);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        /* Секция качества */
        .quality-section {
            margin-bottom: 24px;
        }

        .quality-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        #quality {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
            cursor: pointer;
        }

        /* Кнопки действий */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .generate-btn {
            flex: 2;
            padding: 16px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .history-btn {
            flex: 1;
            padding: 16px 12px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #333);
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-btn:hover {
            background: #e0e0e0;
        }

        /* Секция загрузки */
        .loading-section {
            text-align: center;
            padding: 40px 20px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid var(--tg-theme-button-color, #007AFF);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-tip {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666);
            margin-top: 10px;
        }

        /* Секция результатов */
        .result-section {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .result-section h3 {
            margin-bottom: 16px;
            color: var(--tg-theme-text-color, #333);
        }

        .image-container {
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .image-container img {
            width: 100%;
            height: auto;
            display: block;
        }

        .result-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .save-btn, .share-btn, .new-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .save-btn {
            background: #28a745;
            color: white;
        }

        .share-btn {
            background: var(--tg-theme-button-color, #007AFF);
            color: white;
        }

        .new-btn {
            background: #6c757d;
            color: white;
        }

        .save-btn:hover, .share-btn:hover, .new-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        /* История */
        .history-section {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .history-section h3 {
            margin-bottom: 16px;
            text-align: center;
            color: var(--tg-theme-text-color, #333);
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .history-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .history-item:hover {
            transform: scale(1.05);
        }

        .history-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .back-btn {
            width: 100%;
            padding: 12px;
            background: var(--tg-theme-button-color, #007AFF);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .back-btn:hover {
            opacity: 0.9;
        }

        /* Адаптивность */
        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }

            .header h1 {
                font-size: 24px;
            }

            .style-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .result-actions {
                flex-direction: column;
            }

            .result-actions button {
                flex: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Заголовок приложения -->
        <header class="header">
            <h1>🎨 AI Генератор</h1>
            <p class="subtitle">Создавайте уникальные изображения с помощью ИИ</p>
        </header>

        <!-- Основная форма -->
        <div class="main-content">
            <!-- Поле для ввода промпта -->
            <div class="input-section">
                <label for="prompt">Опишите изображение:</label>
                <textarea 
                    id="prompt" 
                    placeholder="Например: красивый закат над морем в стиле импрессионизма"
                    rows="3"
                ></textarea>
            </div>

            <!-- Выбор стиля -->
            <div class="style-section">
                <label>Выберите стиль:</label>
                <div class="style-grid">
                    <button class="style-btn active" data-style="realistic">
                        🌟 Реалистичный
                    </button>
                    <button class="style-btn" data-style="artistic">
                        🎭 Художественный
                    </button>
                    <button class="style-btn" data-style="cartoon">
                        🎪 Мультяшный
                    </button>
                    <button class="style-btn" data-style="fantasy">
                        🧙‍♂️ Фэнтези
                    </button>
                </div>
            </div>

            <!-- Настройки качества -->
            <div class="quality-section">
                <label for="quality">Качество изображения:</label>
                <select id="quality">
                    <option value="standard">Стандартное (быстро)</option>
                    <option value="hd" selected>HD (рекомендуется)</option>
                    <option value="ultra">Ultra HD (медленно)</option>
                </select>
            </div>

            <!-- Кнопки действий -->
            <div class="action-buttons">
                <button id="generateBtn" class="generate-btn">
                    ✨ Создать изображение
                </button>
                <button id="historyBtn" class="history-btn">
                    📱 История
                </button>
            </div>
        </div>

        <!-- Секция результатов -->
        <div id="resultSection" class="result-section" style="display: none;">
            <h3>Результат:</h3>
            <div id="imageContainer" class="image-container">
                <!-- Сюда будет загружено изображение -->
            </div>
            <div class="result-actions">
                <button id="saveBtn" class="save-btn">💾 Сохранить</button>
                <button id="shareBtn" class="share-btn">📤 Поделиться</button>
                <button id="newImageBtn" class="new-btn">🔄 Новое изображение</button>
            </div>
        </div>

        <!-- Загрузка -->
        <div id="loadingSection" class="loading-section" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Создаем ваше изображение...</p>
            <p class="loading-tip">💡 Это может занять 30-60 секунд</p>
        </div>

        <!-- История изображений -->
        <div id="historySection" class="history-section" style="display: none;">
            <h3>📱 История генераций</h3>
            <div id="historyGrid" class="history-grid">
                <!-- История будет загружена динамически -->
            </div>
            <button id="backFromHistory" class="back-btn">← Назад</button>
        </div>
    </div>

    <script>
        // Встроенный JavaScript для избежания проблем с загрузкой
        let tg = window.Telegram.WebApp;
        let selectedStyle = 'realistic';
        let currentUser = null;
        let generationHistory = [];

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            initTelegramApp();
            initEventListeners();
            loadHistory();
        });

        // Инициализация Telegram Web App
        function initTelegramApp() {
            tg.expand();

            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                currentUser = tg.initDataUnsafe.user;
                console.log('Пользователь авторизован:', currentUser.first_name);
            }

            tg.MainButton.setText('✨ Генерировать изображение');
            tg.MainButton.onClick(handleGenerate);
            tg.BackButton.onClick(goBackToMain);
            tg.ready();
        }

        // Инициализация обработчиков событий
        function initEventListeners() {
            document.querySelectorAll('.style-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedStyle = this.dataset.style;

                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                });
            });

            document.getElementById('generateBtn').addEventListener('click', handleGenerate);
            document.getElementById('historyBtn').addEventListener('click', showHistory);
            document.getElementById('saveBtn').addEventListener('click', saveImage);
            document.getElementById('shareBtn').addEventListener('click', shareImage);
            document.getElementById('newImageBtn').addEventListener('click', goBackToMain);
            document.getElementById('backFromHistory').addEventListener('click', goBackToMain);

            document.getElementById('prompt').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        }

        // Обработчик генерации изображения
        async function handleGenerate() {
            const prompt = document.getElementById('prompt').value.trim();
            const quality = document.getElementById('quality').value;

            if (!prompt) {
                showAlert('Пожалуйста, опишите какое изображение вы хотите создать');
                return;
            }

            if (prompt.length < 10) {
                showAlert('Описание слишком короткое. Добавьте больше деталей (минимум 10 символов)');
                return;
            }

            showLoading();

            const generationData = {
                action: 'generate_image',
                prompt: prompt,
                style: selectedStyle,
                quality: quality,
                user_id: currentUser ? currentUser.id : null,
                user_name: currentUser ? currentUser.first_name : 'Гость',
                timestamp: new Date().toISOString()
            };

            try {
                await sendToBot(generationData);
                showWaitingForResult();
            } catch (error) {
                console.error('Ошибка при генерации:', error);
                showError('Произошла ошибка при генерации изображения. Попробуйте еще раз.');
            }
        }

        function sendToBot(data) {
            return new Promise((resolve, reject) => {
                try {
                    tg.sendData(JSON.stringify(data));
                    resolve();
                } catch (error) {
                    reject(error);
                }
            });
        }

        function showLoading() {
            hideAllSections();
            document.getElementById('loadingSection').style.display = 'block';

            tg.MainButton.setText('Генерируем...');
            tg.MainButton.hide();

            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').textContent = '⏳ Генерируем...';
        }

        function showWaitingForResult() {
            const loadingSection = document.getElementById('loadingSection');
            loadingSection.innerHTML = `
                <div class="loading-spinner"></div>
                <p>🎨 Создаем ваше изображение...</p>
                <p class="loading-tip">💡 Обычно это занимает 30-60 секунд</p>
                <p class="loading-tip">Результат придет в чат с ботом</p>
                <button onclick="goBackToMain()" class="back-btn" style="margin-top: 20px;">
                    ← Создать новое изображение
                </button>
            `;
        }

        function showResult(imageUrl, originalPrompt) {
            hideAllSections();

            const resultSection = document.getElementById('resultSection');
            const imageContainer = document.getElementById('imageContainer');

            imageContainer.innerHTML = `
                <img src="${imageUrl}" alt="Сгенерированное изображение" />
                <p style="margin-top: 10px; font-size: 14px; color: var(--tg-theme-hint-color, #666);">
                    "${originalPrompt}"
                </p>
            `;

            resultSection.style.display = 'block';

            saveToHistory({
                imageUrl: imageUrl,
                prompt: originalPrompt,
                style: selectedStyle,
                timestamp: Date.now()
            });

            tg.MainButton.setText('🔄 Создать новое');
            tg.MainButton.show();
            tg.MainButton.onClick(goBackToMain);

            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        function showHistory() {
            hideAllSections();
            document.getElementById('historySection').style.display = 'block';

            const historyGrid = document.getElementById('historyGrid');

            if (generationHistory.length === 0) {
                historyGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--tg-theme-hint-color, #666);">
                        <p>📱 История пока пуста</p>
                        <p style="font-size: 14px; margin-top: 8px;">Создайте первое изображение!</p>
                    </div>
                `;
            } else {
                historyGrid.innerHTML = generationHistory.map((item, index) => `
                    <div class="history-item" onclick="viewHistoryItem(${index})">
                        <img src="${item.imageUrl}" alt="История ${index + 1}" />
                    </div>
                `).join('');
            }

            tg.BackButton.show();
            tg.MainButton.setText('← Назад к генерации');
            tg.MainButton.show();
            tg.MainButton.onClick(goBackToMain);
        }

        function viewHistoryItem(index) {
            const item = generationHistory[index];
            if (item) {
                showResult(item.imageUrl, item.prompt);
            }
        }

        function saveImage() {
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }

            showAlert('💾 Изображение сохранено в галерею!');

            const saveData = {
                action: 'save_image',
                user_id: currentUser ? currentUser.id : null
            };

            tg.sendData(JSON.stringify(saveData));
        }

        function shareImage() {
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }

            const shareData = {
                action: 'share_image',
                user_id: currentUser ? currentUser.id : null
            };

            tg.sendData(JSON.stringify(shareData));
            showAlert('📤 Изображение отправлено в чат!');
        }

        function goBackToMain() {
            hideAllSections();
            document.querySelector('.main-content').style.display = 'block';

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = false;
            generateBtn.textContent = '✨ Создать изображение';

            tg.MainButton.setText('✨ Генерировать');
            tg.MainButton.show();
            tg.MainButton.onClick(handleGenerate);

            tg.BackButton.hide();
        }

        function hideAllSections() {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('historySection').style.display = 'none';
            document.querySelector('.main-content').style.display = 'none';
        }

        function showMainSection() {
            hideAllSections();
            document.querySelector('.main-content').style.display = 'block';
        }

        function showError(message) {
            hideAllSections();
            showMainSection();

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = false;
            generateBtn.textContent = '✨ Создать изображение';

            tg.MainButton.setText('✨ Генерировать');
            tg.MainButton.show();

            showAlert('❌ ' + message);

            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function showAlert(message) {
            if (tg.showAlert) {
                tg.showAlert(message);
            } else {
                alert(message);
            }
        }

        function saveToHistory(item) {
            generationHistory.unshift(item);

            if (generationHistory.length > 20) {
                generationHistory = generationHistory.slice(0, 20);
            }

            try {
                localStorage.setItem('generation_history', JSON.stringify(generationHistory));
            } catch (error) {
                console.warn('Не удалось сохранить историю:', error);
            }
        }

        function loadHistory() {
            try {
                const saved = localStorage.getItem('generation_history');
                if (saved) {
                    generationHistory = JSON.parse(saved);
                }
            } catch (error) {
                console.warn('Не удалось загрузить историю:', error);
                generationHistory = [];
            }
        }

        window.showGenerationResult = function(imageUrl, prompt) {
            showResult(imageUrl, prompt);
        };

        window.showGenerationError = function(error) {
            showError(error || 'Произошла ошибка при генерации');
        };

        window.addEventListener('beforeunload', function() {
            const closeData = {
                action: 'app_closed',
                user_id: currentUser ? currentUser.id : null
            };

            try {
                tg.sendData(JSON.stringify(closeData));
            } catch (error) {
                console.warn('Не удалось отправить данные о закрытии:', error);
            }
        });

        window.telegramMiniApp = {
            showResult: function(imageUrl, prompt) {
                showResult(imageUrl, prompt);
            },

            showError: function(error) {
                showError(error);
            },

            getCurrentSettings: function() {
                return {
                    style: selectedStyle,
                    quality: document.getElementById('quality').value,
                    prompt: document.getElementById('prompt').value
                };
            },

            setPrompt: function(prompt) {
                document.getElementById('prompt').value = prompt;
            }
        };

        console.log('🚀 Telegram Mini App инициализировано успешно!');
    </script>
</body>
</html>