<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –∑–∞–≥—Ä—É–∑–∫–æ–π CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 16px;
            min-height: 100vh;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 20px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        /* –°–µ–∫—Ü–∏—è –≤–≤–æ–¥–∞ */
        .input-section {
            margin-bottom: 24px;
        }

        .input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #333);
        }

        #prompt {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--tg-theme-button-color, #007AFF);
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: border-color 0.3s ease;
        }

        #prompt:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* –°–µ–∫—Ü–∏—è —Å—Ç–∏–ª–µ–π */
        .style-section {
            margin-bottom: 24px;
        }

        .style-section label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .style-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .style-btn {
            padding: 12px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #333);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .style-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .style-btn.active {
            border-color: var(--tg-theme-button-color, #007AFF);
            background: var(--tg-theme-button-color, #007AFF);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        /* –°–µ–∫—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ */
        .quality-section {
            margin-bottom: 24px;
        }

        .quality-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        #quality {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
            cursor: pointer;
        }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .generate-btn {
            flex: 2;
            padding: 16px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .history-btn {
            flex: 1;
            padding: 16px 12px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #333);
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-btn:hover {
            background: #e0e0e0;
        }

        /* –°–µ–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading-section {
            text-align: center;
            padding: 40px 20px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid var(--tg-theme-button-color, #007AFF);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-tip {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666);
            margin-top: 10px;
        }

        /* –°–µ–∫—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */
        .result-section {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .result-section h3 {
            margin-bottom: 16px;
            color: var(--tg-theme-text-color, #333);
        }

        .image-container {
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .image-container img {
            width: 100%;
            height: auto;
            display: block;
        }

        .result-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .save-btn, .share-btn, .new-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .save-btn {
            background: #28a745;
            color: white;
        }

        .share-btn {
            background: var(--tg-theme-button-color, #007AFF);
            color: white;
        }

        .new-btn {
            background: #6c757d;
            color: white;
        }

        .save-btn:hover, .share-btn:hover, .new-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        /* –ò—Å—Ç–æ—Ä–∏—è */
        .history-section {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .history-section h3 {
            margin-bottom: 16px;
            text-align: center;
            color: var(--tg-theme-text-color, #333);
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .history-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .history-item:hover {
            transform: scale(1.05);
        }

        .history-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .back-btn {
            width: 100%;
            padding: 12px;
            background: var(--tg-theme-button-color, #007AFF);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .back-btn:hover {
            opacity: 0.9;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }

            .header h1 {
                font-size: 24px;
            }

            .style-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .result-actions {
                flex-direction: column;
            }

            .result-actions button {
                flex: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
        <header class="header">
            <h1>üé® AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</h1>
            <p class="subtitle">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –ò–ò</p>
        </header>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
        <div class="main-content">
            <!-- –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–æ–º–ø—Ç–∞ -->
            <div class="input-section">
                <label for="prompt">–û–ø–∏—à–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
                <textarea 
                    id="prompt" 
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫—Ä–∞—Å–∏–≤—ã–π –∑–∞–∫–∞—Ç –Ω–∞–¥ –º–æ—Ä–µ–º –≤ —Å—Ç–∏–ª–µ –∏–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏–∑–º–∞"
                    rows="3"
                ></textarea>
            </div>

            <!-- –í—ã–±–æ—Ä —Å—Ç–∏–ª—è -->
            <div class="style-section">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å:</label>
                <div class="style-grid">
                    <button class="style-btn active" data-style="realistic">
                        üåü –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π
                    </button>
                    <button class="style-btn" data-style="artistic">
                        üé≠ –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π
                    </button>
                    <button class="style-btn" data-style="cartoon">
                        üé™ –ú—É–ª—å—Ç—è—à–Ω—ã–π
                    </button>
                    <button class="style-btn" data-style="fantasy">
                        üßô‚Äç‚ôÇÔ∏è –§—ç–Ω—Ç–µ–∑–∏
                    </button>
                </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ -->
            <div class="quality-section">
                <label for="quality">–ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
                <select id="quality">
                    <option value="standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ (–±—ã—Å—Ç—Ä–æ)</option>
                    <option value="hd" selected>HD (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
                    <option value="ultra">Ultra HD (–º–µ–¥–ª–µ–Ω–Ω–æ)</option>
                </select>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="action-buttons">
                <button id="generateBtn" class="generate-btn">
                    ‚ú® –°–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                </button>
                <button id="historyBtn" class="history-btn">
                    üì± –ò—Å—Ç–æ—Ä–∏—è
                </button>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div id="resultSection" class="result-section" style="display: none;">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
            <div id="imageContainer" class="image-container">
                <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
            </div>
            <div class="result-actions">
                <button id="saveBtn" class="save-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="shareBtn" class="share-btn">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                <button id="newImageBtn" class="new-btn">üîÑ –ù–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
            </div>
        </div>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div id="loadingSection" class="loading-section" style="display: none;">
            <div class="loading-spinner"></div>
            <p>–°–æ–∑–¥–∞–µ–º –≤–∞—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...</p>
            <p class="loading-tip">üí° –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 30-60 —Å–µ–∫—É–Ω–¥</p>
        </div>

        <!-- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
        <div id="historySection" class="history-section" style="display: none;">
            <h3>üì± –ò—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</h3>
            <div id="historyGrid" class="history-grid">
                <!-- –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <button id="backFromHistory" class="back-btn">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <script>
        // –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π JavaScript –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –∑–∞–≥—Ä—É–∑–∫–æ–π
        let tg = window.Telegram.WebApp;
        let selectedStyle = 'realistic';
        let currentUser = null;
        let generationHistory = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            initTelegramApp();
            initEventListeners();
            loadHistory();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        function initTelegramApp() {
            tg.expand();

            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                currentUser = tg.initDataUnsafe.user;
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', currentUser.first_name);
            }

            tg.MainButton.setText('‚ú® –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
            tg.MainButton.onClick(handleGenerate);
            tg.BackButton.onClick(goBackToMain);
            tg.ready();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function initEventListeners() {
            document.querySelectorAll('.style-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedStyle = this.dataset.style;

                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('light');
                    }
                });
            });

            document.getElementById('generateBtn').addEventListener('click', handleGenerate);
            document.getElementById('historyBtn').addEventListener('click', showHistory);
            document.getElementById('saveBtn').addEventListener('click', saveImage);
            document.getElementById('shareBtn').addEventListener('click', shareImage);
            document.getElementById('newImageBtn').addEventListener('click', goBackToMain);
            document.getElementById('backFromHistory').addEventListener('click', goBackToMain);

            document.getElementById('prompt').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        async function handleGenerate() {
            const prompt = document.getElementById('prompt').value.trim();
            const quality = document.getElementById('quality').value;

            if (!prompt) {
                showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –∫–∞–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å');
                return;
            }

            if (prompt.length < 10) {
                showAlert('–û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ. –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π (–º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤)');
                return;
            }

            showLoading();

            const generationData = {
                action: 'generate_image',
                prompt: prompt,
                style: selectedStyle,
                quality: quality,
                user_id: currentUser ? currentUser.id : null,
                user_name: currentUser ? currentUser.first_name : '–ì–æ—Å—Ç—å',
                timestamp: new Date().toISOString()
            };

            try {
                await sendToBot(generationData);
                showWaitingForResult();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:', error);
                showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            }
        }

        function sendToBot(data) {
            return new Promise((resolve, reject) => {
                try {
                    tg.sendData(JSON.stringify(data));
                    resolve();
                } catch (error) {
                    reject(error);
                }
            });
        }

        function showLoading() {
            hideAllSections();
            document.getElementById('loadingSection').style.display = 'block';

            tg.MainButton.setText('–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º...');
            tg.MainButton.hide();

            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º...';
        }

        function showWaitingForResult() {
            const loadingSection = document.getElementById('loadingSection');
            loadingSection.innerHTML = `
                <div class="loading-spinner"></div>
                <p>üé® –°–æ–∑–¥–∞–µ–º –≤–∞—à–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...</p>
                <p class="loading-tip">üí° –û–±—ã—á–Ω–æ —ç—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç 30-60 —Å–µ–∫—É–Ω–¥</p>
                <p class="loading-tip">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏–¥–µ—Ç –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º</p>
                <button onclick="goBackToMain()" class="back-btn" style="margin-top: 20px;">
                    ‚Üê –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                </button>
            `;
        }

        function showResult(imageUrl, originalPrompt) {
            hideAllSections();

            const resultSection = document.getElementById('resultSection');
            const imageContainer = document.getElementById('imageContainer');

            imageContainer.innerHTML = `
                <img src="${imageUrl}" alt="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" />
                <p style="margin-top: 10px; font-size: 14px; color: var(--tg-theme-hint-color, #666);">
                    "${originalPrompt}"
                </p>
            `;

            resultSection.style.display = 'block';

            saveToHistory({
                imageUrl: imageUrl,
                prompt: originalPrompt,
                style: selectedStyle,
                timestamp: Date.now()
            });

            tg.MainButton.setText('üîÑ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ');
            tg.MainButton.show();
            tg.MainButton.onClick(goBackToMain);

            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        function showHistory() {
            hideAllSections();
            document.getElementById('historySection').style.display = 'block';

            const historyGrid = document.getElementById('historyGrid');

            if (generationHistory.length === 0) {
                historyGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--tg-theme-hint-color, #666);">
                        <p>üì± –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞</p>
                        <p style="font-size: 14px; margin-top: 8px;">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!</p>
                    </div>
                `;
            } else {
                historyGrid.innerHTML = generationHistory.map((item, index) => `
                    <div class="history-item" onclick="viewHistoryItem(${index})">
                        <img src="${item.imageUrl}" alt="–ò—Å—Ç–æ—Ä–∏—è ${index + 1}" />
                    </div>
                `).join('');
            }

            tg.BackButton.show();
            tg.MainButton.setText('‚Üê –ù–∞–∑–∞–¥ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
            tg.MainButton.show();
            tg.MainButton.onClick(goBackToMain);
        }

        function viewHistoryItem(index) {
            const item = generationHistory[index];
            if (item) {
                showResult(item.imageUrl, item.prompt);
            }
        }

        function saveImage() {
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }

            showAlert('üíæ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –≥–∞–ª–µ—Ä–µ—é!');

            const saveData = {
                action: 'save_image',
                user_id: currentUser ? currentUser.id : null
            };

            tg.sendData(JSON.stringify(saveData));
        }

        function shareImage() {
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }

            const shareData = {
                action: 'share_image',
                user_id: currentUser ? currentUser.id : null
            };

            tg.sendData(JSON.stringify(shareData));
            showAlert('üì§ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç!');
        }

        function goBackToMain() {
            hideAllSections();
            document.querySelector('.main-content').style.display = 'block';

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = false;
            generateBtn.textContent = '‚ú® –°–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';

            tg.MainButton.setText('‚ú® –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å');
            tg.MainButton.show();
            tg.MainButton.onClick(handleGenerate);

            tg.BackButton.hide();
        }

        function hideAllSections() {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('historySection').style.display = 'none';
            document.querySelector('.main-content').style.display = 'none';
        }

        function showMainSection() {
            hideAllSections();
            document.querySelector('.main-content').style.display = 'block';
        }

        function showError(message) {
            hideAllSections();
            showMainSection();

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = false;
            generateBtn.textContent = '‚ú® –°–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';

            tg.MainButton.setText('‚ú® –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å');
            tg.MainButton.show();

            showAlert('‚ùå ' + message);

            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function showAlert(message) {
            if (tg.showAlert) {
                tg.showAlert(message);
            } else {
                alert(message);
            }
        }

        function saveToHistory(item) {
            generationHistory.unshift(item);

            if (generationHistory.length > 20) {
                generationHistory = generationHistory.slice(0, 20);
            }

            try {
                localStorage.setItem('generation_history', JSON.stringify(generationHistory));
            } catch (error) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é:', error);
            }
        }

        function loadHistory() {
            try {
                const saved = localStorage.getItem('generation_history');
                if (saved) {
                    generationHistory = JSON.parse(saved);
                }
            } catch (error) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é:', error);
                generationHistory = [];
            }
        }

        window.showGenerationResult = function(imageUrl, prompt) {
            showResult(imageUrl, prompt);
        };

        window.showGenerationError = function(error) {
            showError(error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
        };

        window.addEventListener('beforeunload', function() {
            const closeData = {
                action: 'app_closed',
                user_id: currentUser ? currentUser.id : null
            };

            try {
                tg.sendData(JSON.stringify(closeData));
            } catch (error) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –∑–∞–∫—Ä—ã—Ç–∏–∏:', error);
            }
        });

        window.telegramMiniApp = {
            showResult: function(imageUrl, prompt) {
                showResult(imageUrl, prompt);
            },

            showError: function(error) {
                showError(error);
            },

            getCurrentSettings: function() {
                return {
                    style: selectedStyle,
                    quality: document.getElementById('quality').value,
                    prompt: document.getElementById('prompt').value
                };
            },

            setPrompt: function(prompt) {
                document.getElementById('prompt').value = prompt;
            }
        };

        console.log('üöÄ Telegram Mini App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
    </script>
</body>
</html>